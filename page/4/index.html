<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="fanquqi.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="fanquqi.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="fanquqi.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="fanquqi.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="fanquqi.github.io/css/main.css">


<link rel="stylesheet" href="fanquqi.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fanquqi.github.io","root":"fanquqi.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Raise my flag to the new age.">
<meta property="og:type" content="website">
<meta property="og:title" content="fix u dream">
<meta property="og:url" content="https://fanquqi.github.io/page/4/index.html">
<meta property="og:site_name" content="fix u dream">
<meta property="og:description" content="Raise my flag to the new age.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fanquqi">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fanquqi.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>fix u dream</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="fanquqi.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">fix u dream</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="fanquqi.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="fanquqi.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/09/08/python-mysql%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/09/08/python-mysql%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">python-mysql使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-09-08 15:37:27" itemprop="dateCreated datePublished" datetime="2017-09-08T15:37:27+08:00">2017-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>主要介绍MySQLdb 模块使用</p>
<h1 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h1><p>首先需要确认模块安装</p>
<h1 id="创建数据库表"><a href="#创建数据库表" class="headerlink" title="创建数据库表"></a>创建数据库表</h1><pre><code>#!/usr/bin/python
# -*- coding: UTF-8 -*-

import MySQLdb

# 打开数据库连接
db = MySQLdb.connect(&quot;localhost&quot;,&quot;testuser&quot;,&quot;test123&quot;,&quot;TESTDB&quot; )

# 使用cursor()方法获取操作游标 
cursor = db.cursor()

# 如果数据表已经存在使用 execute() 方法删除表。
cursor.execute(&quot;DROP TABLE IF EXISTS EMPLOYEE&quot;)

# 创建数据表SQL语句
sql = &quot;&quot;&quot;CREATE TABLE EMPLOYEE (
     FIRST_NAME  CHAR(20) NOT NULL,
     LAST_NAME  CHAR(20),
     AGE INT,  
     SEX CHAR(1),
     INCOME FLOAT )&quot;&quot;&quot;

cursor.execute(sql)

# 关闭数据库连接
db.close()</code></pre><h1 id="数据库查询"><a href="#数据库查询" class="headerlink" title="数据库查询"></a>数据库查询</h1><pre><code>#!/usr/bin/python
# -*- coding: UTF-8 -*-

import MySQLdb

# 打开数据库连接
db = MySQLdb.connect(&quot;localhost&quot;,&quot;testuser&quot;,&quot;test123&quot;,&quot;TESTDB&quot; )

# 使用cursor()方法获取操作游标 
cursor = db.cursor()

# SQL 查询语句
sql = &quot;SELECT * FROM EMPLOYEE \
   WHERE INCOME &gt; &apos;%d&apos;&quot; % (1000)
try:
   # 执行SQL语句
       cursor.execute(sql)
   # 获取所有记录列表
       results = cursor.fetchall()
   for row in results:
    fname = row[0]
    lname = row[1]
    age = row[2]
    sex = row[3]
      income = row[4]
  # 打印结果
    print &quot;fname=%s,lname=%s,age=%d,sex=%s,income=%d&quot; % \
         (fname, lname, age, sex, income )</code></pre><p>except:<br>    print “Error: unable to fecth data”</p>
<h1 id="关闭数据库连接"><a href="#关闭数据库连接" class="headerlink" title="关闭数据库连接"></a>关闭数据库连接</h1><p>db.close()</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/08/15/open-falcon%E5%8D%87%E7%BA%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/08/15/open-falcon%E5%8D%87%E7%BA%A7/" class="post-title-link" itemprop="url">open-falcon升级</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-15 11:08:50" itemprop="dateCreated datePublished" datetime="2017-08-15T11:08:50+08:00">2017-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E7%9B%91%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">监控</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>这次迁移本来想使用docker，看了下官方给的镜像2G多，差点吓死我，另外还有mysql，redis融合在里面。我们的mysql不在机器本地，也没有打算迁移。为了防止上次ucloud  B机房整体服务断绝联系之后一个报警都没有尴尬发生，我准备把这台机器放到其他机房，万一下次ucloud B机房挂掉最起码监控是有的，但是如果它全线挂。。。。呸，上次就是我这乌鸦嘴。。。</p>
</blockquote>
<p>&emsp;&emsp;这次迁移过程具体分为</p>
<ul>
<li>falcon—plus 部署</li>
<li>新系统测试</li>
<li>各机器falcon-agent升级</li>
<li>域名更改，grafana更改</li>
</ul>
<h1 id="falcon-plus部署"><a href="#falcon-plus部署" class="headerlink" title="falcon-plus部署"></a>falcon-plus部署</h1><p>&emsp;&emsp;参考<a href="https://book.open-falcon.org/zh_0_2/quick_install/upgrade.html">官网</a><br>&emsp;&emsp;首先数据库有更改，增加了一个<a href="https://github.com/open-falcon/falcon-plus/blob/master/scripts/mysql/db_schema/5_alarms-db-schema.sql">alarm库</a> 这个是用来存储报警历史的，在dashboard中有展示，需要我们down下来执行下这个SQL。然后<code>sender</code>模块和<code>alarm</code>模块合二为一了，也就是说报警直接由<code>alarm</code>模块发送了，这点我刚看到的时候有一点纠结，因为v0.1版本我们没有使用<code>sender</code>模块,而是直接使用的一个脚本实时读redis，然后根据级别判断，发送邮件，微信，短信，钉钉，这不知道是不是意味着我必须修改<code>alarm</code>源码了。我们先厚着头皮继续部署，遇到什么问题解决什么问题。</p>
<p>机器初始环境部署我在这里忽略了，包括golang等一些环境的安装。</p>
<p><strong>执行SQL</strong><br>    wget <a href="https://github.com/open-falcon/falcon-plus/blob/master/scripts/mysql/db_schema/5_alarms-db-schema.sql">https://github.com/open-falcon/falcon-plus/blob/master/scripts/mysql/db_schema/5_alarms-db-schema.sql</a> &gt; mysql -h127.0.0.1 -ufalcon -p</p>
<p><strong>二进制安装</strong></p>
<p>安装包下载<a href="https://github.com/open-falcon/falcon-plus/releases/download/v0.2.0/open-falcon-v0.2.0.tar.gz">地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd $falcon_dir</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;open-falcon&#x2F;falcon-plus&#x2F;releases&#x2F;download&#x2F;v0.2.0&#x2F;open-falcon-v0.2.0.tar.gz</span><br><span class="line">tar -zxvf open-falcon-v0.2.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>然后对应修改每个模块的配置文件<br>这个我就不记录了</p>
<p><strong>启动|停止|检查</strong><br>    ./open-falcon start|stop|check </p>
<p><strong>各节点启动方式</strong></p>
<ol>
<li>进到相应模块bin目录，执行二进制文件 例：./falcon-agent start|stop|restart|tail </li>
<li>在$faocon_dir ./open-falcon start|stop|reload|monitor</li>
</ol>
<h2 id="dashboard部署"><a href="#dashboard部署" class="headerlink" title="dashboard部署"></a>dashboard部署</h2><p>&emsp;&emsp;参考<a href="https://github.com/open-falcon/dashboard">官网</a></p>
<p>操作按照<a href="https://book.open-falcon.org/zh_0_2/quick_install/frontend.html">官网文档</a>依次进行</p>
<p>这里有个小坑<br>配置openLDAP登录的时候，配置<br>配置也较之前0.1版本有所不同）</p>
<p>0.1版本可以用reader用户+密码去验证用户名密码</p>
<pre><code>&quot;ldap&quot;: {
&quot;enabled&quot;: true,
&quot;addr&quot;: &quot;ldap.example.com:389&quot;,
&quot;baseDN&quot;: &quot;dc=example,dc=com&quot;,
&quot;bindDN&quot;: &quot;cn=reader,dc=example,dc=com&quot;,
&quot;bindPasswd&quot;: &quot;123456&quot;,
&quot;userField&quot;: &quot;uid&quot;,
&quot;attributes&quot;: [&quot;uid&quot;,&quot;givenName&quot;,&quot;sn&quot;,&quot;mail&quot;]</code></pre><p>0.2版本验证方式直接是向openLDAP的389端口验证该用户名的密码正确性，不用配置reader用户和密码</p>
<pre><code>LDAP_ENABLED = os.environ.get(&quot;LDAP_ENABLED&quot;,True)
LDAP_SERVER = os.environ.get(&quot;LDAP_SERVER&quot;,&quot;ldap.example.com:389&quot;)
LDAP_BASE_DN = os.environ.get(&quot;LDAP_BASE_DN&quot;,&quot;uid=%s,OU=People,DC=example,DC=com&quot;)
LDAP_BINDDN_FMT = os.environ.get(&quot;LDAP_BINDDN_FMT&quot;,&quot;uid=%s,OU=People,DC=example,DC=com&quot;)
LDAP_SEARCH_FMT = os.environ.get(&quot;LDAP_SEARCH_FMT&quot;,&quot;(uid=%s)&quot;)
LDAP_ATTRS = [&quot;uid&quot;,&quot;givenName&quot;,&quot;sn&quot;,&quot;mail&quot;, &quot;cn&quot;]</code></pre><p>具体LDAP概念比如cn sn <a href="https://segmentfault.com/a/1190000002607140">参考</a></p>
<p>配置完成。但是。。之前的用户不能登录成功。。。<br>看源码看到这句<br><img src="http://or2jd66dq.bkt.clouddn.com/open-falcon-dashboard-bug.png" alt=""><br>WTF，so，只能删掉用户数据，重建，但是。。。</p>
<p>&emso;&emsp;我把用户都删了重建，这个导致了后来一个bug，因为报警都是按组发送的，所以用户删完之后，组别在dashboard中没有显示了。。新建会显示 <strong>组已经存在</strong> 我去，原来数据库中还有一个action表，里面还有原来分组的消息，我只能新建另一个分组，到portal中（v0.1版本我没有下掉，监控不能断）把报警接收组改成新加的这个组。。</p>
<p>然后就OK了。<br>但是。上文说过，alarm与sender合并了，所以报警怎么发？</p>
<p>我去看了下alarm的配置文件<br>发现了这个  </p>
<pre><code>&quot;worker&quot;: {
    &quot;im&quot;: 10,
    &quot;sms&quot;: 20,
    &quot;mail&quot;: 10
},</code></pre><p>对比上下文，我感觉这可能就是发微信，短信，邮件的worker数，不知道代码做没做判断，我直接把worker数改成了0，重启  </p>
<p>查看redis  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">进到cli</span><br><span class="line">redis-cli </span><br><span class="line"></span><br><span class="line">keys *</span><br><span class="line"></span><br><span class="line">lrange &#x2F;sms 0 0</span><br></pre></td></tr></table></figure>

<p>看到有报警信息  跟0.1版本一模一样  我的脚本都不用修改，真是完美。</p>
<h1 id="新系统测试"><a href="#新系统测试" class="headerlink" title="新系统测试"></a>新系统测试</h1><p>模拟报警发送消息。略</p>
<h1 id="各机器agent更新"><a href="#各机器agent更新" class="headerlink" title="各机器agent更新"></a>各机器agent更新</h1><ul>
<li>./falcon-agent 二进制文件更新 </li>
<li>配置文件更新（记得server地址更改）</li>
</ul>
<p>写好 ansible role直接执行，</p>
<h1 id="nginx转发更改"><a href="#nginx转发更改" class="headerlink" title="nginx转发更改"></a>nginx转发更改</h1><p>此dashboard是使用的flask+gunicron 起的 我在内网nginx上做反向代理转发到这台机器8080 一直502，不得其解，因为着急验收，我直接在falcon_plus这台云主机上yum安装了一个nginx，然后内网nginx请求转发到这台机器80，就OK了。原因有时间再去看吧。。。或者说下次遇到falsk再看吧。。。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp;遇到问题解决问题，不要思考的过于多导致自己迟迟不动手。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/08/11/python%E7%88%AC%E8%99%AB%E4%B8%80-%E7%AE%80%E5%8D%95%E7%88%AC%E5%8F%96%E8%B1%86%E7%93%A3%E9%AB%98%E5%88%86%E7%94%B5%E5%BD%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/08/11/python%E7%88%AC%E8%99%AB%E4%B8%80-%E7%AE%80%E5%8D%95%E7%88%AC%E5%8F%96%E8%B1%86%E7%93%A3%E9%AB%98%E5%88%86%E7%94%B5%E5%BD%B1/" class="post-title-link" itemprop="url">python爬虫一,简单爬取豆瓣高分电影</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-11 16:44:45" itemprop="dateCreated datePublished" datetime="2017-08-11T16:44:45+08:00">2017-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>作者作为一个运维，始终有个开发的心，在打杂的空隙中抽时间搞点东西，怒刷存在感。</p>
<p>这将会是一个系列，本节先从基本的抓取豆瓣高分电影开始。后期将会有更多有意义的内容，比如做代理抓取草榴的图片，视频给各位看官。。。开玩笑，不要当真，这估计会被抓的。。</p>
<h2 id="工具说明"><a href="#工具说明" class="headerlink" title="工具说明"></a>工具说明</h2><ul>
<li>python版本 2.7.8</li>
<li>编辑器 sublime</li>
</ul>
<h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><blockquote>
<p>抓取Top100电影，及相关影评.</p>
</blockquote>
<h2 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Top 1, 肖申克的救赎</span><br><span class="line">   影评：希望让人自由。</span><br><span class="line">Top 2, 霸王别姬</span><br><span class="line">   影评：风华绝代。</span><br><span class="line">Top 3, 这个杀手不太冷</span><br><span class="line">   影评：怪蜀黍和小萝莉不得不说的故事。</span><br><span class="line">Top 4, 阿甘正传</span><br><span class="line">   影评：一部美国近现代史。</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Top 98, 末代皇帝</span><br><span class="line">   影评：“不要跟我比惨，我比你更惨”再适合这部电影不过了。</span><br><span class="line">Top 99, 阿凡达</span><br><span class="line">   影评：绝对意义上的美轮美奂。</span><br><span class="line">Top 100, 摩登时代</span><br><span class="line">   影评：大时代中的人生，小人物的悲喜。</span><br></pre></td></tr></table></figure>

<h2 id="前期工作流程"><a href="#前期工作流程" class="headerlink" title="前期工作流程"></a>前期工作流程</h2><ul>
<li>分析url<ul>
<li>对每页的url特征有些了解</li>
</ul>
</li>
<li>分析HTML <ul>
<li>根据HTML特征设计相关正则对内容进行抓取</li>
</ul>
</li>
</ul>
<h2 id="后期工作展望"><a href="#后期工作展望" class="headerlink" title="后期工作展望"></a>后期工作展望</h2><ul>
<li>使用多线程爬取 </li>
<li>了解python爬虫框架Scrapy</li>
<li>了解模拟登陆或者加代理的爬取方法</li>
<li>熟悉HTML标签规则</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/08/04/mysql%E8%AF%AF%E5%88%A0%E9%99%A4%E8%A1%A8%E6%81%A2%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/08/04/mysql%E8%AF%AF%E5%88%A0%E9%99%A4%E8%A1%A8%E6%81%A2%E5%A4%8D/" class="post-title-link" itemprop="url">mysql误删除表恢复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-04 17:12:09" itemprop="dateCreated datePublished" datetime="2017-08-04T17:12:09+08:00">2017-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h1><p> 今天有个开发哥哥来找我。说有个医生信息表被删除了（测试服）但是现在版本正在测试，账号已经登不上了，bug群里已经有人说话了，CTO已经看到了，情况已经很紧急了。但是我之前也没有遇到过这类事情，而且测试服mysql是不备份的，一时不知道要怎么办。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p><strong>但是</strong> 事情还是要解决也总是有解决办法。下边按照先后顺序记录了下我的操作方案。</p>
<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><blockquote>
<p>使用bin-log，我们测试服mysql是有记录mysql-binlog的，（本来也是没有开的，在六月份的时候测试服总是内存不够用，我把数据库从本地迁移独立了出来开启了bin-log）</p>
</blockquote>
<p><strong>bin-log恢复方案介绍</strong></p>
<p>先查看这次今天mysql操作记录，发现没有什么操作，毕竟周五， 所以计划直接恢复到删表之前（就是昨天，中间操作的一段时间有几个今天修改的记录不见得情况），然后再从删表后的时间节点到现在恢复，等于只跳过了那条删表操作，别的操作都重新来一遍。</p>
<h3 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h3><p>首先查看mysql-binlog 找到误操作drop table的时间节点 这里没有图文。。。</p>
<pre><code>// 查找对应的bin-log文件
mysqlbinlog mysql-bin.000002 | grep -A4 &quot;table_name&quot; </code></pre><p>然后恢复对应时间节点恢复（其实mysqlbinlog也可以对应postion节点恢复）<br>    mysqlbinlog -d test_medical –stop-datetime=’2017-08-03 17:57:05’ /home/mysql/3306/data/mysql-bin.000002 | mysql -uroot -p -P 3306 -S /home/mysql/3306/mysql.sock<br>    // -d 数据库名  –stop-datetime 结束时间点，–start-datetime 开始时间节点 二者可以一起写就是中间时间短的操作 </p>
<p>可想而知我这样操作的结果，肯定是一堆冲突，因为当前数据库已经是操作过一遍的结果了，再把执行过得命令拿过来执行下，肯定是有错误。<br>所以我们方案一肯定是不可取的。</p>
<p><img src="http://or2jd66dq.bkt.clouddn.com/binlog-error.png" alt=""></p>
<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><blockquote>
<p>我之前是有迁移过这个MySQL的，我赶紧看了下迁移的数据压缩包还在时间是2017-6-19,顿时感觉欣喜若狂</p>
</blockquote>
<p>我的设想是这样的，因为时间久远肯定不能再这个mysql上恢复到一个多月之前，我想把数据包下到本地电脑mysql，恢复数据，把这个表的dump下来，传到测试服mysql。然后数据包压缩完之后有3G多 下载限速1M大约一个小时。<br>太久了。<br>我索性在测试数据库服务器上 用ansible由装了一个mysql实例端口3309用时两分钟不到。</p>
<p>恢复数据 <a href="https://fanquqi.github.io/2017/06/16/%E5%87%A0%E7%A7%8Dmysql%E8%BF%81%E7%A7%BB/">参考文档</a></p>
<p>然后用mysqlbinlog恢复这一个多月来的数据。</p>
<pre><code>mysqlbinlog -d test_medical --stop-datetime=&apos;2017-08-03 17:57:05&apos; /home/mysql/3306/data/mysql-bin.000001 | mysql -uroot -p -P3309 -S /home/mysql/3309/mysql.sock

mysqlbinlog -d test_medical --stop-datetime=&apos;2017-08-03 17:57:05&apos; /home/mysql/3306/data/mysql-bin.000002 | mysql -uroot -p -P3309 -S /home/mysql/3309/mysql.sock</code></pre><p>备份表</p>
<pre><code>mysqldump -uroot -p test_medical table_name &gt; table_name.sql</code></pre><p>然后进到mysql source一下  结束。。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>binlog是结合备份来用的，其实我们这次恢复也算是 <code>备份—恢复</code>流程</p>
<p>所以</p>
<p>数据库备份很重要，</p>
<p>数据库备份很重要，</p>
<p>数据库备份很重要。 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/08/02/MySQL%E9%97%AE%E9%A2%98%E6%9F%A5%E6%89%BE-%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/08/02/MySQL%E9%97%AE%E9%A2%98%E6%9F%A5%E6%89%BE-%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B/" class="post-title-link" itemprop="url">MySQL问题查找,状态查看</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-02 16:35:18" itemprop="dateCreated datePublished" datetime="2017-08-02T16:35:18+08:00">2017-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>导火索: 今天后端上线，上线脚本执行到数据库更改的时候卡住了(公司开发的devops,web操作)，登录机器查看ansible进程是在的，证明SQL 执行出错了。之前我很少接触mysql，全是部署增删改查，多表查询都少用，所以这次是一边Google一边查找原因。</p>
<p>首先，这次数据库修改一共有四处，前三个都已经执行完成，就是最后一个加字段的没有成功。</p>
<p><strong>排查过程</strong></p>
<ol>
<li><p>查看表大小，确认不是因为表大导致执行时间过长。<br> 其实这个再上线操作的时候又应该有个大概的认识，比如这个表功能大概是多少行，属于哪个工程等等，如果对业务熟悉，应该很快判断的出。<br> <code>相关命令</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 直接查找，可能较慢</span><br><span class="line">select count(id) from table_name; </span><br><span class="line">&#x2F;&#x2F; 查找information_schema中的信息</span><br><span class="line">select * from information_schema.TABLES </span><br><span class="line">    where information_schema.TABLES.TABLE_SCHEMA&#x3D;&#39;databasename&#39;</span><br><span class="line">    and information_schema.TABLES.TABLE_NAME&#x3D;&#39;tablename&#39;\G</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果不是表太大，可以看下正在进行的事务<br> 了解事务的工作模式很重要，首先要知道自己的MySQL隔离级别，及每种隔离级别的特点。参考<a href="https://tech.meituan.com/innodb-lock.html">美团点评团队的分享</a> 我们是使用的 已提交读（Read committed）</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 查看当前隔离级别</span><br><span class="line">SELECT @@session.tx_isolation;</span><br><span class="line">&#x2F;&#x2F; 查看当前执行的事务</span><br><span class="line">SELECT * FROM information_schema.INNODB_TRX;</span><br></pre></td></tr></table></figure>
<p> 当时主库加上字段之后，从库一直加不上字段就是因为有另一个事务一直没有提交，导致表一直是只读状态，阻塞了。</p>
</li>
</ol>
<p>select * from information_schema.TABLES<br>        where information_schema.TABLES.TABLE_SCHEMA=’online_medical’<br>        and information_schema.TABLES.TABLE_NAME=’api_familydoctorservice’\G</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/20/nginx%E4%B9%8B%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81%E9%99%90%E9%80%9F%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/20/nginx%E4%B9%8B%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81%E9%99%90%E9%80%9F%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">nginx之请求限流限速问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-20 15:04:07" itemprop="dateCreated datePublished" datetime="2017-07-20T15:04:07+08:00">2017-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="单位时间按照IP地址限速"><a href="#单位时间按照IP地址限速" class="headerlink" title="单位时间按照IP地址限速"></a>单位时间按照IP地址限速</h1><p>工作当中经常需要按照IP地址限速，加白名单或者黑名单，这里面就会用到map来设置。看下边例子展示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;  </span><br><span class="line">    geo $white_ip &#123;</span><br><span class="line">        ranges;</span><br><span class="line">        default 0;</span><br><span class="line">        127.0.0.1-127.0.0.1 1;</span><br><span class="line"></span><br><span class="line">        36.110.16.242-36.110.16.242 1</span><br><span class="line">         </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    map $white_ip $white_ip_address &#123;</span><br><span class="line">        0 $binary_remote_addr;</span><br><span class="line">        1 &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    limit_req_zone $white_ip_address zone&#x3D;:10m rate&#x3D;20r&#x2F;s;</span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释下</strong></p>
<p>上述通过<code>geo模块</code> 设定了白名单 </p>
<p><strong>ngx_http_geo_module</strong> 模块可以用来创建变量，其值依赖于客户端IP地址。<br>语法: geo [$address] $variable { … }    设置在http 模块中<br><code>[$address]</code> 可以为空，使用默认变量也就是$remote_addr 其实例子中 <code>geo $white_ip {}</code>  就相当于<code>geo $remote_addr $white_ip {}</code><br><code>$white_ip</code> 命名为<code>white_ip</code><br><code>ranges</code> 使用以地址段的形式定义地址，这个参数必须放在首位。为了加速装载地址库，地址应按升序定义。<br><code>default</code> 设置默认值，如果客户端地址不能匹配任意一个定义的地址，nginx将使用此值。</p>
<p>注：如果36.110.16.242 这个IP地址访问本站, <code>white_ip</code> 这个变量值就是 1,否则就是0 </p>
<p>通过<code>map模块</code> 对$white_ip进行映射</p>
<p><strong>ngx_http_map_module</strong> 模块可以创建变量，这些变量的值与另外的变量值相关联（上文的$white_ip）。允许分类或者同时映射多个值到多个不同值并储存到一个变量中，map指令用来创建变量，但是仅在变量被接受的时候执行视图映射操作，对于处理没有引用变量的请求时，这个模块并没有性能上的缺失。 </p>
<p>语法: map $var1 $var2 { … }</p>
<p>上文map指令是将$white_ip值为0的，也就是受限制的IP，映射为客户端IP。将$white_ip值为1的，映射为空的字符串。<br><code>limit_conn_zone</code>和<code>limit_req_zone</code>指令对于键为空值的将会被忽略，从而实现对于列出来的IP不做限制。</p>
<p><code>limit_req_zone</code> 真正操作限速<br><strong>ngx_http_limit_req_module</strong> 模块</p>
<h1 id="下载限速"><a href="#下载限速" class="headerlink" title="下载限速"></a>下载限速</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;file &#123; </span><br><span class="line">    limit_rate 128k;</span><br><span class="line"># 限制下载速度128K&#x2F;s </span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line"># 如果想设置用户下载文件的前10m大小时不限速，大于10m后再以128kb&#x2F;s限速可以增加以下配内容，修改nginx.conf文件</span><br><span class="line"></span><br><span class="line">location &#x2F;download &#123; </span><br><span class="line">       limit_rate_after 10m; </span><br><span class="line">       limit_rate 128k; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="屏蔽请求"><a href="#屏蔽请求" class="headerlink" title="屏蔽请求"></a>屏蔽请求</h1><p>1.单一url屏蔽</p>
<p>2.动态url屏蔽 如<a href="http://yourvhost/abc123.html">http://yourvhost/abc123.html</a> bac456.html</p>
<p>3.屏蔽referer</p>
<p>4.屏蔽http_host</p>
<p>5.屏蔽来源IP</p>
<p>6.屏蔽文件类型</p>
<p>7.屏蔽目录</p>
<p>8.屏蔽一个文件</p>
<p>9.多条件叠加屏蔽 例子为 屏蔽 url为这个 and 浏览器为windows and host为这个的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1.anti a request this url is single url ex : http:&#x2F;&#x2F;yourvhost&#x2F;xxxx.html</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">    if ($request_uri ~* ^&#x2F;index.html$)&#123;</span><br><span class="line">        </span><br><span class="line">        return 403;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">2.anti a dynamic url ex : http:&#x2F;&#x2F;yourvhost&#x2F;abc123.html bac456.html</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">               if ($request_uri  ~* &quot;^&#x2F;test&#x2F;\w&#123;1,3&#125;\d&#123;1,3&#125;&#125;\.html$&quot;)&#123;</span><br><span class="line"></span><br><span class="line">               return 403;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">3.anti a referer</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">   if ($http_referer  ~* ^http:&#x2F;&#x2F;test.360.cn&#x2F;index.html$)&#123;</span><br><span class="line"></span><br><span class="line">   return 403;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line">4.anti a http_host</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">                if ($http_host  ~* ^test.360.cn$)&#123;</span><br><span class="line">                return 403;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">5.anti source IP</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line"></span><br><span class="line">  deny 192.168.100.42;</span><br><span class="line">  deny 192.168.0.0&#x2F;16;</span><br><span class="line">  deny 192.168.100.0&#x2F;24;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">6.anti file type</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg|html)$</span><br><span class="line"></span><br><span class="line">           &#123;</span><br><span class="line">                deny all;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">7.anti directory</span><br><span class="line"></span><br><span class="line">location ~ ^&#x2F;(test|tset)&#x2F;</span><br><span class="line">           &#123;</span><br><span class="line">                deny all;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">8.anti a file</span><br><span class="line"></span><br><span class="line">location ~ &#x2F;test&#x2F;test.html  &#123;</span><br><span class="line">    deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">9.Multiple conditions anti ex : url is http:&#x2F;&#x2F;yourvhost&#x2F;test&#x2F;aaa111.html AND  browser is Windows AND http_host is test.360.cn</span><br><span class="line"></span><br><span class="line">if ($request_uri ~ &quot;^&#x2F;test&#x2F;\w&#123;1,3&#125;\d&#123;1,3&#125;&#125;\.html$&quot;) &#123;</span><br><span class="line"></span><br><span class="line">    set $iftmp Y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($http_user_agent ~ &quot;.*Windows NT 6.1.*&quot;) &#123;</span><br><span class="line"> </span><br><span class="line">    set $iftmp &quot;$&#123;iftmp&#125;Y&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">if ($http_host  ~* ^test.360.cn$) &#123;</span><br><span class="line"></span><br><span class="line">    set $iftmp &quot;$&#123;iftmp&#125;Y&quot;;</span><br><span class="line">&#125;</span><br><span class="line">if ($iftmp &#x3D; YYY) &#123; return 403;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/18/socket%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/18/socket%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">socket解读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-18 10:24:52" itemprop="dateCreated datePublished" datetime="2017-07-18T10:24:52+08:00">2017-07-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>之前一直部署各种开源软件，包括很多RPC服务，其中很多都会有一个socket，但是很多地方可以用地址加端口替代，我虽然说做运维也将近两年了，但是毕竟大学是数学专业，不是计算机科班出身，对什么TCP/IP啊socket啊，都得是自己看书了解。so，抽个空补习了一下。</p>
</blockquote>
<p>用廖雪峰老师的话说</p>
<blockquote>
<p>Socket是网络编程的一个抽象概念。通常我们用一个Socket表示“打开了一个网络链接”，而打开一个Socket需要知道目标计算机的IP地址和端口号，再指定协议类型即可。</p>
</blockquote>
<h1 id="TCP-IP"><a href="#TCP-IP" class="headerlink" title="TCP/IP"></a>TCP/IP</h1><p>要理解socket首先要理解TCP/IP，面试过程当中我们经常被问到ISO七层模型相关的知识，类似TCP/IP工作在第几层？<br>TCP/IP（Transmission Control Protocol/Internet Protocol）即传输控制协议/网间协议，定义了主机如何连入因特网及数据如何再它们之间传输的标准，</p>
<p>从字面意思来看TCP/IP是TCP和IP协议的合称，但实际上TCP/IP协议是指因特网整个TCP/IP协议簇。不同于ISO模型的七个分层，TCP/IP协议参考模型把所有的TCP/IP系列协议归类到四个抽象层中</p>
<p>应用层：TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet 等等</p>
<p>传输层：TCP，UDP</p>
<p>网络层：IP，ICMP，OSPF，EIGRP，IGMP</p>
<p>数据链路层：SLIP，CSLIP，PPP，MTU</p>
<p>每一层都是建立在下一层提供的服务上，为上一层提供服务</p>
<p>python socket客户端编写(down 新浪首页)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">s.connect((&#39;www.sina.com&#39;,80))</span><br><span class="line"></span><br><span class="line">s.send(&#39;GET &#x2F; HTTP&#x2F;1.1\r\nHost: www.sina.com.cn\r\nConnection: close\r\n\r\n&#39;)</span><br><span class="line"></span><br><span class="line">buffer &#x3D; []</span><br><span class="line">while True:</span><br><span class="line"></span><br><span class="line">    d &#x3D; s.recv(2048)</span><br><span class="line">    if d:</span><br><span class="line">        buffer.append(d)</span><br><span class="line">    else:</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">data&#x3D;&#39;&#39;.join(buffer)</span><br><span class="line">s.close</span><br><span class="line">header, html &#x3D; data.split(&#39;\r\n\r\n&#39;,1)</span><br><span class="line">print header</span><br></pre></td></tr></table></figure>

<p>server端编写</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/13/MySQL%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/13/MySQL%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">MySQL使用记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-13 16:02:23" itemprop="dateCreated datePublished" datetime="2017-07-13T16:02:23+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>数据库现在为止我只接触过MySQL，MySQL自从被oracle收购后，就衍生出三大阵营，Drizzle、MariaDB和Percona Server（包括XtraDB引擎），第一个没接触过不太了解，MariaDB与percona又有很多相似点，比如都支持XtraDB（innodb加强版）<br>看看两者优缺点：</p>
<ul>
<li>Percona团队的最终声明是“Percona Server是由Oracle发布的最接近官方MySQL Enterprise发行版的版本”，因此与其他更改了大量基本核心MySQL代码的分支有所区别。</li>
<li>XtraDB 存储引擎是完全的向下兼容，在 MariaDB 中，XtraDB 存储引擎被标识为”ENGINE=InnoDB”，这个与 InnoDB 是一样的，所以你可以直接用XtraDB 替换掉 InnoDB 而不会产生任何问题。</li>
<li>MariaDB的目的是完全兼容MySQL，包括API和命令行，使之能轻松成为MySQL的代替品。在存储引擎方面，10.0.9版起使用XtraDB（名称代号为Aria）来代替MySQL的InnoDB。</li>
<li>Percona Server的一个缺点是他们自己管理代码，不接受外部开发人员的贡献，以这种方式确保他们对产品中所包含功能的控制。</li>
</ul>
<p>总之，二者目前为止没有拉开什么差距，所以可以自由选择。<br>阿里使用的percona 但是Google使用的MariaDB。。。</p>
<p>我也是用的percona。下边以它为例说明。</p>
<p>数据库也是个比较大的技术栈，三言两语说不完，工具书都特别厚，我写这篇文章的目的无非就是想给自己一个查看SQL语句的地方，见识比较少，有错误我肯定不是故意的，全文参考这个<a href="http://lib.csdn.net/maquealone/352262/chart/MySQL">技能图谱</a></p>
<h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><p>直接yum就可以，国内有清华源，中科院源，比较快，官网下载简直是灾难。<br>可以写ansible-playbook，没有难点不多说。</p>
<h2 id="配置文件详解"><a href="#配置文件详解" class="headerlink" title="配置文件详解"></a>配置文件详解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">[mysqld3306]</span><br><span class="line"></span><br><span class="line"># 为PXC定制</span><br><span class="line">binlog_format&#x3D;ROW</span><br><span class="line">default-storage-engine         &#x3D; InnoDB</span><br><span class="line">innodb_autoinc_lock_mode&#x3D;2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 绑定地址之后只能通过内部网络访问</span><br><span class="line"></span><br><span class="line">bind-address&#x3D;10.******</span><br><span class="line"></span><br><span class="line">auto-increment-increment &#x3D; 2</span><br><span class="line">auto-increment-offset &#x3D; 1</span><br><span class="line"></span><br><span class="line"># 使用 xtrabackup-v2 必须制定datadir, 因为操作可能直接对 datadir进行</span><br><span class="line">datadir&#x3D;&#x2F;home&#x2F;mysql&#x2F;3306&#x2F;data</span><br><span class="line"></span><br><span class="line"># http:&#x2F;&#x2F;www.percona.com&#x2F;doc&#x2F;percona-xtrabackup&#x2F;2.2&#x2F;innobackupex&#x2F;privileges.html#permissions-and-privileges-needed</span><br><span class="line"># 权限的配置</span><br><span class="line"># xtrapbackup在Donor上执行，因此只需localhost的权限</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 约定:</span><br><span class="line">server-id &#x3D; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># wsrep模式不依赖于GTID</span><br><span class="line"># 开启GTID</span><br><span class="line"># enforce_gtid_consistency&#x3D;1</span><br><span class="line"># gtid_mode&#x3D;on</span><br><span class="line"></span><br><span class="line"># 即便临时作为Slave，也记录自己的binlog</span><br><span class="line">log-slave-updates&#x3D;1</span><br><span class="line"></span><br><span class="line"># master_info_repository&#x3D;TABLE</span><br><span class="line"># relay_log_info_repository&#x3D;TABLE</span><br><span class="line"></span><br><span class="line"># GENERAL #</span><br><span class="line">user                           &#x3D; mysql</span><br><span class="line">port                           &#x3D; 3306</span><br><span class="line">socket                         &#x3D; &#x2F;home&#x2F;mysql&#x2F;3306&#x2F;mysql.sock</span><br><span class="line">pid-file                       &#x3D; &#x2F;home&#x2F;mysql&#x2F;3306&#x2F;mysql.pid</span><br><span class="line"></span><br><span class="line"># MyISAM #</span><br><span class="line">key-buffer-size                &#x3D; 32M</span><br><span class="line">myisam-recover                 &#x3D; FORCE,BACKUP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ft-min-word-len &#x3D; 4</span><br><span class="line">event-scheduler &#x3D; 0</span><br><span class="line"></span><br><span class="line"># SAFETY #</span><br><span class="line">max-allowed-packet             &#x3D; 16M</span><br><span class="line"></span><br><span class="line">skip-name-resolve</span><br><span class="line">max_connections &#x3D; 2000</span><br><span class="line">max_connect_errors &#x3D; 30</span><br><span class="line"></span><br><span class="line">back-log &#x3D; 500</span><br><span class="line"></span><br><span class="line">character-set-client-handshake &#x3D; 1</span><br><span class="line">character-set-server &#x3D; utf8mb4</span><br><span class="line">collation-server &#x3D; utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line">#character-set-client-handshake&#x3D;1</span><br><span class="line">#character-set-client&#x3D;utf8</span><br><span class="line">#character-set-server&#x3D;utf8</span><br><span class="line">#collation-server&#x3D;utf8_general_ci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#key-buffer-size &#x3D; 256M</span><br><span class="line">table-open-cache &#x3D; 2048</span><br><span class="line">max-allowed-packet &#x3D; 2048M</span><br><span class="line">slave-skip-errors &#x3D; all                       #Skip duplicated key</span><br><span class="line">sort-buffer-size &#x3D; 4M</span><br><span class="line">join-buffer-size &#x3D; 8M</span><br><span class="line">thread-cache-size &#x3D; 50</span><br><span class="line">concurrent-insert &#x3D; 2</span><br><span class="line"></span><br><span class="line">thread-stack &#x3D; 192K</span><br><span class="line">net-buffer-length &#x3D; 8K</span><br><span class="line">read-buffer-size &#x3D; 256K</span><br><span class="line">read-rnd-buffer-size &#x3D; 16M</span><br><span class="line">bulk-insert-buffer-size &#x3D; 64M</span><br><span class="line"></span><br><span class="line"># 采用thread pool来处理连接</span><br><span class="line">thread_handling&#x3D;pool-of-threads</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sql-mode                       &#x3D; STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_AUTO_VALUE_ON_ZERO,NO_ENGINE_SUBSTITUTION,ONLY_FULL_GROUP_BY</span><br><span class="line">sysdate-is-now                 &#x3D; 1</span><br><span class="line">innodb                         &#x3D; FORCE</span><br><span class="line">innodb-strict-mode             &#x3D; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># BINARY LOGGING #</span><br><span class="line">log-bin                        &#x3D; &#x2F;home&#x2F;mysql&#x2F;3306&#x2F;data&#x2F;mysql-bin</span><br><span class="line">expire-logs-days               &#x3D; 5</span><br><span class="line"># LOGGING #</span><br><span class="line"># log-output&#x3D;file 默认就是FILE</span><br><span class="line">log-error                      &#x3D; &#x2F;home&#x2F;mysql&#x2F;3306&#x2F;data&#x2F;mysql-error.log</span><br><span class="line">long-query-time &#x3D; 0.3</span><br><span class="line"># log-queries-not-using-indexes  &#x3D; 1</span><br><span class="line">slow-query-log                 &#x3D; 1</span><br><span class="line">slow-query-log-file            &#x3D; &#x2F;home&#x2F;mysql&#x2F;3306&#x2F;data&#x2F;mysql-slow.log</span><br><span class="line"></span><br><span class="line"># 默认为0(MySQL不控制binlog的输出)</span><br><span class="line"># sync-binlog                    &#x3D; 1</span><br><span class="line"></span><br><span class="line"># CACHES AND LIMITS #</span><br><span class="line"></span><br><span class="line">tmp-table-size                 &#x3D; 32M</span><br><span class="line">max-heap-table-size            &#x3D; 32M</span><br><span class="line"></span><br><span class="line"># 频繁修改的表不适合做query-cache, 否则反而影响效率</span><br><span class="line">query-cache-type               &#x3D; 0</span><br><span class="line">query-cache-size               &#x3D; 0</span><br><span class="line"># query-cache-limit &#x3D; 2M</span><br><span class="line"># query-cache-min-res-unit &#x3D; 512</span><br><span class="line"></span><br><span class="line">thread-cache-size              &#x3D; 100</span><br><span class="line">open-files-limit               &#x3D; 65535</span><br><span class="line">table-definition-cache         &#x3D; 1024</span><br><span class="line">table-open-cache               &#x3D; 4096</span><br><span class="line"></span><br><span class="line"># INNODB #</span><br><span class="line">innodb-flush-method            &#x3D; O_DIRECT</span><br><span class="line">innodb-log-files-in-group      &#x3D; 2</span><br><span class="line"></span><br><span class="line"># innodb-file-per-table &#x3D; 1设置之后， 下面的配置基本失效</span><br><span class="line">innodb_data_file_path &#x3D; ibdata1:10M:autoextend</span><br><span class="line">innodb-thread-concurrency &#x3D; 32</span><br><span class="line">innodb-log-file-size           &#x3D; 256M</span><br><span class="line">innodb-flush-log-at-trx-commit &#x3D; 2</span><br><span class="line">innodb-file-per-table          &#x3D; 1</span><br><span class="line"># 内存: 全部内存*0.7</span><br><span class="line">innodb-buffer-pool-size &#x3D; 25G</span><br><span class="line"></span><br><span class="line">performance-schema &#x3D; 0</span><br><span class="line">net-read-timeout &#x3D; 60</span><br><span class="line"></span><br><span class="line"># innodb-open-files 在MySQL5.6 auto-sized</span><br><span class="line"># 来自May2</span><br><span class="line">innodb-rollback-on-timeout</span><br><span class="line">innodb-status-file &#x3D; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># http:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.6&#x2F;en&#x2F;innodb-performance-multiple_io_threads.html</span><br><span class="line"># http:&#x2F;&#x2F;zhan.renren.com&#x2F;formysql?tagId&#x3D;3942&amp;checked&#x3D;true</span><br><span class="line"># 从MySQL 5.5</span><br><span class="line"># innodb_file_io_threads &#x3D; 4</span><br><span class="line">innodb-read-io-threads &#x3D; 16</span><br><span class="line">innodb-write-io-threads &#x3D; 8</span><br><span class="line"></span><br><span class="line">innodb-io-capacity &#x3D; 2000</span><br><span class="line"># innodb-stats-update-need-lock &#x3D; 0 # MySQL 5.6中无效</span><br><span class="line"># innodb-stats-auto-update &#x3D; 0</span><br><span class="line">innodb-old-blocks-pct &#x3D; 75</span><br><span class="line"># innodb-adaptive-flushing-method &#x3D; &quot;estimate&quot;</span><br><span class="line"># innodb-adaptive-flushing &#x3D; 1</span><br><span class="line"></span><br><span class="line"># https:&#x2F;&#x2F;www.facebook.com&#x2F;notes&#x2F;mysql-at-facebook&#x2F;repeatable-read-versus-read-committed-for-innodb&#x2F;244956410932</span><br><span class="line"># READ-COMMITTED 每次QUERY都要求调用: read_view_open_now, 而REPEATABLE-READ每次Transaction中只要求一次</span><br><span class="line"># REPEATABLE-READ 会导致读写不同步</span><br><span class="line">transaction-isolation &#x3D; READ-COMMITTED</span><br><span class="line"></span><br><span class="line">innodb-sync-spin-loops &#x3D; 100</span><br><span class="line">innodb-spin-wait-delay &#x3D; 30</span><br><span class="line"></span><br><span class="line">innodb-file-format &#x3D; &quot;Barracuda&quot;</span><br><span class="line">innodb-file-format-max &#x3D; &quot;Barracuda&quot;</span><br></pre></td></tr></table></figure>

<h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><blockquote>
<p>日常操作无非就是增删改查。也可分为库层面操作，与表层面操作。</p>
</blockquote>
<h2 id="库操作"><a href="#库操作" class="headerlink" title="库操作"></a>库操作</h2><p>一般库操作很少，没有什么花样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 创建数据库</span><br><span class="line">create database online_database;        </span><br><span class="line"># 查看数据库</span><br><span class="line">show databases;  </span><br><span class="line"># 查看数据库信息    </span><br><span class="line">show create database online_database;</span><br><span class="line"># 修改数据库的编码，可使用上一条语句查看是否修改成功</span><br><span class="line">alter database online_database default character set gbk collate gbk_bin;      </span><br><span class="line"># 删除数据库</span><br><span class="line">drop database online_database;</span><br></pre></td></tr></table></figure>

<h1 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h1><h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create table IF NOT EXISTS qbus_log_collect_state (</span><br><span class="line">    id int primary key not null auto_increment, </span><br><span class="line">    host varchar(50) not null default &#39;&#39;, </span><br><span class="line">    cluster varchar(50) not null default &#39;&#39;,</span><br><span class="line">    topic varchar(100) not null default &#39;&#39;, </span><br><span class="line">    state int not null default 0, </span><br><span class="line">    log_path varchar(100) not null default &#39;&#39;)，</span><br><span class="line">    update_time ;</span><br></pre></td></tr></table></figure>

<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><pre><code>insert into table_name (id,count) value (1,2);</code></pre><h3 id="去重插入"><a href="#去重插入" class="headerlink" title="去重插入"></a>去重插入</h3><pre><code>REPLACE INTO `table_name`(`col_name`, ...) VALUES (...);</code></pre><h3 id="删除表某条数据-where-必须加，不然删除掉全表所有数据，谨慎"><a href="#删除表某条数据-where-必须加，不然删除掉全表所有数据，谨慎" class="headerlink" title="删除表某条数据(where 必须加，不然删除掉全表所有数据，谨慎)"></a>删除表某条数据(where 必须加，不然删除掉全表所有数据，谨慎)</h3><pre><code>delete from table_name where id=1;</code></pre><h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><pre><code>drop table table_name；</code></pre><h4 id="快速删表"><a href="#快速删表" class="headerlink" title="快速删表"></a>快速删表</h4><p>ln xxx.ibd xxx.ibd_bak</p>
<p>drop table xxx</p>
<p>rm -f xxx.ibd_bak</p>
<h3 id="删表数据，不删表结构（下边两个SQL，TRUNCATE-会删除自增字段记录，而delete不会）"><a href="#删表数据，不删表结构（下边两个SQL，TRUNCATE-会删除自增字段记录，而delete不会）" class="headerlink" title="删表数据，不删表结构（下边两个SQL，TRUNCATE 会删除自增字段记录，而delete不会）"></a>删表数据，不删表结构（下边两个SQL，TRUNCATE 会删除自增字段记录，而delete不会）</h3><pre><code>TRUNCATE TABLE table_name;
delete from table_name;</code></pre><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><pre><code>select * from table_name;</code></pre><p>查询数据直接追加到文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -s -N -h10.108.93.250 -uuser -p -P3306 database_name -e &#39;select topic_name,cluster_name,log_path,hdfs_path from log_info where cluster_name in (&quot;bjyt_priv_huajiao&quot;,&quot;bjyt_priv_huajiao2&quot;);&#39; &gt; huaojiao_log_path.txt</span><br></pre></td></tr></table></figure>

<h3 id="去重查询"><a href="#去重查询" class="headerlink" title="去重查询"></a>去重查询</h3><pre><code>select distinct col_name,values from table_name;</code></pre><h3 id="按照时间查询"><a href="#按照时间查询" class="headerlink" title="按照时间查询"></a>按照时间查询</h3><pre><code>&quot;update_time&quot;为表中更新时间字段，curdate() 为获取当前时间的函数 可以使用 + - 来控制前后几天 
select * from qbus_topic_info where date(update_time) = curdate()-1;    </code></pre><h3 id="查找重复数据"><a href="#查找重复数据" class="headerlink" title="查找重复数据"></a>查找重复数据</h3><pre><code>select COUNT(*) as repetitions, cluster_name,topic_name from topic_flow_daily where date=&quot;2017-11-9&quot; group by cluster_name,topic_name HAVING repetitions &gt; 1;    </code></pre><h3 id="添加唯一约束（联合唯一约束）"><a href="#添加唯一约束（联合唯一约束）" class="headerlink" title="添加唯一约束（联合唯一约束）"></a>添加唯一约束（联合唯一约束）</h3><h4 id="需要在表中没有重复数据的情况下，否则加不上去"><a href="#需要在表中没有重复数据的情况下，否则加不上去" class="headerlink" title="需要在表中没有重复数据的情况下，否则加不上去"></a>需要在表中没有重复数据的情况下，否则加不上去</h4><pre><code>ALTER TABLE jw_resource ADD UNIQUE KEY(resource_name, resource_type);</code></pre><h3 id="添加字段"><a href="#添加字段" class="headerlink" title="添加字段"></a>添加字段</h3><pre><code>alter table &apos;user_movement_log&apos; Add column GatewayId int not null default 0 AFTER &apos;Regionid&apos;;</code></pre><h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><pre><code>ALTER TABLE testalter_tbl  DROP i;</code></pre><h3 id="更改字段"><a href="#更改字段" class="headerlink" title="更改字段"></a>更改字段</h3><pre><code>alter table topic_flow_daily change  total_request total_requests bigint not null default 0;</code></pre><p>z</p>
<p>#索引<br>B树，B+树 ：<br><a href="https://zhuanlan.zhihu.com/p/27700617">https://zhuanlan.zhihu.com/p/27700617</a><br><a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html">http://blog.codinglabs.org/articles/theory-of-mysql-index.html</a></p>
<p>#索引优化</p>
<p><a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html">http://blog.codinglabs.org/articles/theory-of-mysql-index.html</a></p>
<p><a href="http://blog.codinglabs.org/articles/index-condition-pushdown.html">http://blog.codinglabs.org/articles/index-condition-pushdown.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/13/uwsgi%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/13/uwsgi%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">uwsgi笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-13 14:38:09" itemprop="dateCreated datePublished" datetime="2017-07-13T14:38:09+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>前言，来公司一年了，对uwsgi的操作，只停留在部署，或者restart，并没有主动配置过，今天看nginx的时候看到nginx(我们的nginx是只转发)的请求是转发的本地某个端口，是个uwsgi提供的fastrouter服务。在此记录一下。</p>
</blockquote>
<p>由于我们后端使用的都是Django项目，所以整体都是这个架构<code>nginx</code>–&gt;<code>uwsgi</code>–&gt;<code>django</code>.所以对uwsgi的了解也很重要。<br>fastrouter使用放到后面先说，uwsgi的普通配置。</p>
<p>版本：uWSGI==2.0.12</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>WSGI（Python Web Server Gateway Interface，缩写为WSGI） 是一种 Web 服务器网关接口。它是一个 Web 服务器（如 Nginx）与应用服务器（如 uWSGI 服务器）通信的一种规范。<br>uwsgi 是一种协议<br>uWSGI uWSGI是一个Web服务器，它实现了WSGI协议、uwsgi、http等协议。uWSGI，既不用wsgi协议也不用FastCGI协议，而是自创了一个uwsgi的协议，uwsgi协议是一个uWSGI服务器自有的协议，它用于定义传输信息的类型（type of information），每一个uwsgi packet前4byte为传输信息类型描述，它与WSGI相比是两样东西。据说该协议大约是fcgi协议的10倍那么快。</p>
<p>优点：</p>
<ul>
<li>超快的性能。</li>
<li>低内存占用（实测为apache2的mod_wsgi的一半左右）。</li>
<li>多app管理。</li>
<li>详尽的日志功能（可以用来分析app性能和瓶颈）。</li>
<li>高度可定制（内存大小限制，服务一定次数后重启等）。</li>
</ul>
<p>版本：uWSGI==2.0.12</p>
<h2 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h2><p>安装就是直接在virtualenv中pip安装就好了<br>pip install uWSGI</p>
<h2 id="uwsgitop"><a href="#uwsgitop" class="headerlink" title="uwsgitop"></a>uwsgitop</h2><blockquote>
<p>监控工具</p>
</blockquote>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>pip install uwsgitop </p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>uwsgitop /tmp/stats.sock</p>
<h2 id="plugins使用"><a href="#plugins使用" class="headerlink" title="plugins使用"></a>plugins使用</h2><h3 id="fastrouter"><a href="#fastrouter" class="headerlink" title="fastrouter"></a>fastrouter</h3><p>这是一个负载均衡插件，比如说四个uwsgi节点提供服务，这样在nginx上面可以配置成upstream，分流到四个uwsgi服务上，但是如果是上线，或者有一个节点挂掉了怎么办，只能是收到500报警在手动剔除吗？ to yung to sample!! 当然不是，这个时候就用到fastrouter了。<br>看<a href="http://uwsgi-docs-cn.readthedocs.io/zh_CN/latest/Fastrouter.html?highlight=fast">官网</a></p>
<blockquote>
<p>For advanced setups uWSGI includes the “fastrouter” plugin, a proxy/load-balancer/router speaking the uwsgi protocol. It is built in by default. You can put it between your webserver and real uWSGI instances to have more control over the routing of HTTP requests to your application servers.</p>
</blockquote>
<p>它的功能proxy/load-banlance/router<br>简述一下配置：</p>
<p><strong>nginx配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;test &#123;</span><br><span class="line">        include    uwsgi_params;</span><br><span class="line">        uwsgi_pass 127.0.0.1:3030;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastrouter-server端配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;uwsgi id &#x3D; &quot;fastrouter&quot;&gt;</span><br><span class="line">    &lt;fastrouter&gt;127.0.0.1:3030&lt;&#x2F;fastrouter&gt;</span><br><span class="line">    &lt;fastrouter-subscription-server&gt;127.0.0.1:3131&lt;&#x2F;fastrouter-subscription-server&gt;</span><br><span class="line">    &lt;enable-threads&#x2F;&gt;</span><br><span class="line">    &lt;master&#x2F;&gt;</span><br><span class="line">    &lt;fastrouter-stats&gt;127.0.0.1:9595&lt;&#x2F;fastrouter-stats&gt;</span><br><span class="line">&lt;&#x2F;uwsgi&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>3030为当前uWSGI fastrouter server的端口，前面的空代表当前主机地址。（nginx会用到这个端口）</li>
<li>3131fastrouter-subscription-server 表示当前uWSGI fastrouter server的订阅地址。（web应用服务会用到）</li>
<li>stats：uWSGI的统计服务机制，访问会返回一个json对象，都是<a href="http://uwsgi-docs.readthedocs.io/en/latest/StatsServer.html">状态统计信息</a> 格式可以是一个端口，也可以是一个socket</li>
</ul>
<p><strong>uwsgi实例配置</strong></p>
<p>实例1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;uwsgi id &#x3D; &quot;subserver1&quot;&gt;</span><br><span class="line">    &lt;stats&gt;127.0.0.1:9393&lt;&#x2F;stats&gt;</span><br><span class="line">    &lt;processes&gt;4&lt;&#x2F;processes&gt;</span><br><span class="line">    &lt;enable-threads&#x2F;&gt;</span><br><span class="line">    &lt;memory-report&#x2F;&gt;</span><br><span class="line">    &lt;subscribe-to&gt;127.0.0.1:3131:test&lt;&#x2F;subscribe-to&gt;</span><br><span class="line">    &lt;socket&gt;127.0.0.1:3232&lt;&#x2F;socket&gt;</span><br><span class="line">    &lt;file&gt;.&#x2F;server.py&lt;&#x2F;file&gt;</span><br><span class="line">    &lt;master&#x2F;&gt;</span><br><span class="line">    &lt;weight&gt;8&lt;&#x2F;weight&gt;</span><br><span class="line">&lt;&#x2F;uwsgi&gt;</span><br></pre></td></tr></table></figure>
<p>实例2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;uwsgi id &#x3D; &quot;subserver2&quot;&gt;</span><br><span class="line">    &lt;stats&gt;127.0.0.1:9494&lt;&#x2F;stats&gt;</span><br><span class="line">    &lt;processes&gt;4&lt;&#x2F;processes&gt;</span><br><span class="line">    &lt;enable-threads&#x2F;&gt;</span><br><span class="line">    &lt;memory-report&#x2F;&gt;</span><br><span class="line">    &lt;subscribe-to&gt;127.0.0.1:3131:test&lt;&#x2F;subscribe-to&gt;</span><br><span class="line">    &lt;socket&gt;127.0.0.1:3333&lt;&#x2F;socket&gt;</span><br><span class="line">    &lt;file&gt;.&#x2F;server.py&lt;&#x2F;file&gt;</span><br><span class="line">    &lt;master&#x2F;&gt;</span><br><span class="line">    &lt;weight&gt;2&lt;&#x2F;weight&gt;</span><br><span class="line">&lt;&#x2F;uwsgi&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><stats>127.0.0.1:9494</stats> 这个可以把9494改为0 则为自动分配 也可以改成socket</p>
</li>
<li><p>我们通过subscribe-to变量来订阅fastrouter server（127.0.0.1:3131）,冒号后跟着的是对应请求的域名，只有来自当前域名的请求才会进入当前web节点。当然这个可以设置多个subscribe-to，例如：subscribe-to=127.0.0.1:3131:test1</p>
</li>
<li><p>weight 权重分配</p>
</li>
</ul>
<p>由于我们线上使用的是fastrouter,所以在这儿就只说了这个，其实uwsgi的负载均衡使用不只有这一种手段<br>有兴趣可以看下<a href="http://www.cnblogs.com/codeape/p/4064815.html">这篇博文</a></p>
<h3 id="harakiri"><a href="#harakiri" class="headerlink" title="harakiri"></a>harakiri</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/12/%E8%AE%B0%E5%BD%95%E4%B8%BB%E6%9C%BAhistory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/12/%E8%AE%B0%E5%BD%95%E4%B8%BB%E6%9C%BAhistory/" class="post-title-link" itemprop="url">记录主机history</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-12 14:10:20" itemprop="dateCreated datePublished" datetime="2017-07-12T14:10:20+08:00">2017-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>起因，有个哥们儿要离职，直接上线上把他机器训练的东西拷贝到电脑本地，我们用的vpn，有些服务对此有点依赖，不详细说，总之影响到了一丢丢线上的情况，所以CTO很不高兴，机器历史记录也没有，啥都没有，多亏他承认了。但是我这个运维还是多少显得有点尴尬。</p>
</blockquote>
<p>下面说一些改进措施</p>
<ul>
<li>不准任何人直接登录线上机器，必须通过跳板机（上传现在文件也必须通过跳板机加以控制）</li>
<li>openvpn与线上带宽解耦</li>
<li>openvpn限速，线上加iptables阻止openvpn的地址，只接受跳板机(加一条运维通道，永远有B方案)</li>
<li>历史记录需要详细记录</li>
</ul>
<p>前三条很好就解决了。<br>下面内容详细记录下第四条的实现方法。</p>
<p>bash是多数Linux发行版默认的shell，虽然不及zsh好用，但比其它的shell好太多。<br>我们的生产服务器很多，没有用跳板机，又是多人共用root用户，为了审计用户操作，需要记录执行命令的用户、时间和ip等信息。本文之所以要优化，主要是因为bash默认配置存在以下几点不足：</p>
<ol>
<li><p>历史记录保存数目有限，默认1000条</p>
</li>
<li><p>记录不详细，不记录命令执行时间/执行用户名/用户ip等</p>
</li>
<li><p>历史记录会丢失，主要有两种情况：</p>
<ol>
<li>bash异常退出 </li>
<li>同一用户多处登录或开了多个会话，只会记录最后退出的会话历史</li>
</ol>
</li>
</ol>
<p>所以我决心自己记录下<code>bash_history</code> 并把它写到ES之中<a href="https://fanquqi.github.io/2017/06/12/file-beat%E6%8E%A5%E5%85%A5ELK/">传送门</a>,这样有人做了什么非法的事情，即使他清空了历史记录我的ES中也能存着他的罪证，除非他每条history都秒删，在速度上超过filebeat的读取的速度，事实证明不怎么可能。</p>
<h2 id="常规rsyslog实现"><a href="#常规rsyslog实现" class="headerlink" title="常规rsyslog实现"></a>常规rsyslog实现</h2><blockquote>
<p><a href="http://www.361way.com/history-log-audit/4147.html">参考链接</a></p>
</blockquote>
<h3 id="配置全局bash历史记录格式"><a href="#配置全局bash历史记录格式" class="headerlink" title="配置全局bash历史记录格式"></a>配置全局bash历史记录格式</h3><p>在/etc/bashrc中写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PROMPT_COMMAND&#x3D;&#39;RETRN_VAL&#x3D;$?;logger -p local6.debug &quot;$(who am i) [$$]: $(history 1 | sed &quot;s&#x2F;^[ ]*[0-9]\+[ ]*&#x2F;&#x2F;&quot; ) [$RETRN_VAL]&quot;&#39;</span><br></pre></td></tr></table></figure>


<h3 id="配置rsyslog"><a href="#配置rsyslog" class="headerlink" title="配置rsyslog"></a>配置rsyslog</h3><p>新增文件/etc/rsyslog.d/bash.conf,内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local6.*    &#x2F;var&#x2F;log&#x2F;bash_history.log</span><br></pre></td></tr></table></figure>

<h3 id="重启rsyslogd"><a href="#重启rsyslogd" class="headerlink" title="重启rsyslogd"></a>重启rsyslogd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rsyslogd</span><br></pre></td></tr></table></figure>

<h3 id="ansible-脚本"><a href="#ansible-脚本" class="headerlink" title="ansible 脚本"></a>ansible 脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- name: copy file to &#x2F;etc</span><br><span class="line">  copy: src&#x3D;bash_log.conf dest&#x3D;&#x2F;var&#x2F;tmp</span><br><span class="line"></span><br><span class="line">- name: echo to &#x2F;etc&#x2F;bashrc</span><br><span class="line">  shell: cat &#x2F;var&#x2F;tmp&#x2F;bash_log.conf &gt;&gt; &#x2F;etc&#x2F;bashrc</span><br><span class="line">  register: bashrc</span><br><span class="line"></span><br><span class="line">- name: source file</span><br><span class="line">  shell: source &#x2F;etc&#x2F;bashrc</span><br><span class="line">  when: bashrc.changed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- name: copy bash.conf to &#x2F;etc&#x2F;rsyslog.d</span><br><span class="line">  copy: src&#x3D;bash.conf dest&#x3D;&#x2F;etc&#x2F;rsyslog.d</span><br><span class="line">  register: rsyslog_conf</span><br><span class="line"></span><br><span class="line">- name: restart rsyslog</span><br><span class="line">  service: name&#x3D;rsyslog.service state&#x3D;restarted</span><br><span class="line">  when: rsyslog_conf.changed</span><br></pre></td></tr></table></figure>
<p>刷到每个机器上就好了   注意最好配置下logrotate每天切割一下</p>
<p>这样就可以在kibana中看到每个登录人员的操作情况了。<br><img src="http://or2jd66dq.bkt.clouddn.com/bash_history_kibana.png" alt=""></p>
<h2 id="查看用户痕迹过程展示"><a href="#查看用户痕迹过程展示" class="headerlink" title="查看用户痕迹过程展示"></a>查看用户痕迹过程展示</h2><p>上面中控机上是每个人对应一个自己名字拼音的用户，使用此用户跳到线上机器，但是测试环境是直接本地可以连，测试被人搞坏了进度delay怎么办？也需要查证，可以使用以下方法<br><img src="http://or2jd66dq.bkt.clouddn.com/bash_history_modify.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="fanquqi.github.io/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="fanquqi.github.io/">1</a><span class="space">&hellip;</span><a class="page-number" href="fanquqi.github.io/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="fanquqi.github.io/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="fanquqi.github.io/page/8/">8</a><a class="extend next" rel="next" href="fanquqi.github.io/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">fanquqi</p>
  <div class="site-description" itemprop="description">Raise my flag to the new age.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="fanquqi.github.io/archives/">
        
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fanquqi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="fanquqi.github.io/lib/anime.min.js"></script>
  <script src="fanquqi.github.io/lib/velocity/velocity.min.js"></script>
  <script src="fanquqi.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="fanquqi.github.io/js/utils.js"></script>

<script src="fanquqi.github.io/js/motion.js"></script>


<script src="fanquqi.github.io/js/schemes/muse.js"></script>


<script src="fanquqi.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
