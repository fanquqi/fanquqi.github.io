<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="fanquqi.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="fanquqi.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="fanquqi.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="fanquqi.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="fanquqi.github.io/css/main.css">


<link rel="stylesheet" href="fanquqi.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fanquqi.github.io","root":"fanquqi.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Raise my flag to the new age.">
<meta property="og:type" content="website">
<meta property="og:title" content="fix u dream">
<meta property="og:url" content="https://fanquqi.github.io/page/5/index.html">
<meta property="og:site_name" content="fix u dream">
<meta property="og:description" content="Raise my flag to the new age.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fanquqi">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fanquqi.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>fix u dream</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="fanquqi.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">fix u dream</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="fanquqi.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="fanquqi.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/11/ucloud-API%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/11/ucloud-API%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">通过ucloud_API查看资源价格</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-11 17:34:50" itemprop="dateCreated datePublished" datetime="2017-07-11T17:34:50+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>我们公司有些服务使用ucloud主机，付费等问题都是我负责，前一段时间跟他们的架构沟通了一下，发现他们的API还是很方便的，尤其他们提供弹性IP可以自由伸缩，我们完全可以写个脚本统计带宽，实时调整。如果在云上跑docker，完全可以直接通过流量挥着访问量实时业务扩容。运维真的做到自动化。</p>
</blockquote>
<pre><code>ucloud提供了官方的`apk`[链接](https://github.com/ucloud-web/python-sdk-v2.git)</code></pre><p>有的同学直接把它写成了python命令 <a href="https://pypi.python.org/pypi/ucli/">链接</a></p>
<p>本来只是想做一个统计价格的工具，写着写着，就像反正收集实例信息还不如都挨个统计一下展示出来，<br>因为：</p>
<ol>
<li>ucloud信息展示的并不清晰  </li>
<li>如果看到价格有异常肯定第一时间想知道到底哪个贵些，贵在哪里，更方便直观一些</li>
</ol>
<p>我在下边主要展示一下自己手写的几个脚本通过API获取实例信息，再通过实例信息获取实例价格，最后统一发送到influxDB中去到grafana上呈现。定时每天跑一次。代码水平有限，大家请不要嘲笑。</p>
<p>先来看下他的apk和配置文件<br>他的public_key 和 private_key 涉及到自己独特的加秘方式。可以去ucloud官网看看 </p>
<h2 id="apk-py"><a href="#apk-py" class="headerlink" title="apk.py"></a><code>apk.py</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import hashlib, json, httplib</span><br><span class="line">import urlparse</span><br><span class="line">import urllib</span><br><span class="line">import sys</span><br><span class="line">from config import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UCLOUDException(Exception):</span><br><span class="line">    def __str__(self):</span><br><span class="line">        return &quot;Error&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def _verfy_ac(private_key, params):</span><br><span class="line">    items &#x3D; params.items()</span><br><span class="line">    items.sort()</span><br><span class="line"></span><br><span class="line">    params_data &#x3D; &quot;&quot;</span><br><span class="line">    for key, value in items:</span><br><span class="line">        params_data &#x3D; params_data + str(key) + str(value)</span><br><span class="line"></span><br><span class="line">    params_data &#x3D; params_data+private_key</span><br><span class="line"></span><br><span class="line">    &#39;&#39;&#39;use sha1 to encode keys&#39;&#39;&#39;</span><br><span class="line">    hash_new &#x3D; hashlib.sha1()</span><br><span class="line">    hash_new.update(params_data)</span><br><span class="line">    hash_value &#x3D; hash_new.hexdigest()</span><br><span class="line">    return hash_value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UConnection(object):</span><br><span class="line">    def __init__(self, base_url):</span><br><span class="line">        self.base_url &#x3D; base_url</span><br><span class="line">        o &#x3D; urlparse.urlsplit(base_url)</span><br><span class="line">        if o.scheme &#x3D;&#x3D; &#39;https&#39;:</span><br><span class="line">            self.conn &#x3D; httplib.HTTPSConnection(o.netloc)</span><br><span class="line">        else:</span><br><span class="line">            self.conn &#x3D; httplib.HTTPConnection(o.netloc)</span><br><span class="line"></span><br><span class="line">    def __del__(self):</span><br><span class="line">        self.conn.close()</span><br><span class="line"></span><br><span class="line">    def get(self, resouse, params):</span><br><span class="line">        resouse +&#x3D; &quot;?&quot; + urllib.urlencode(params)</span><br><span class="line">        print(&quot;%s%s&quot; % (self.base_url, resouse))</span><br><span class="line">        self.conn.request(&quot;GET&quot;, resouse)</span><br><span class="line">        response &#x3D; json.loads(self.conn.getresponse().read())</span><br><span class="line">        return response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UcloudApiClient(object):</span><br><span class="line">    # 添加 设置 数据中心和  zone 参数</span><br><span class="line">    def __init__(self, base_url, public_key, private_key):</span><br><span class="line">        self.g_params &#x3D; &#123;&#125;</span><br><span class="line">        self.g_params[&#39;PublicKey&#39;] &#x3D; public_key</span><br><span class="line">        self.private_key &#x3D; private_keyurl</span><br><span class="line">        self.conn &#x3D; UConnection(base_url)</span><br><span class="line"></span><br><span class="line">    def get(self, uri, params):</span><br><span class="line">        # print params</span><br><span class="line">        _params &#x3D; dict(self.g_params, **params)</span><br><span class="line"></span><br><span class="line">        if project_id :</span><br><span class="line">            _params[&quot;ProjectId&quot;] &#x3D; project_id</span><br><span class="line"></span><br><span class="line">        _params[&quot;Signature&quot;] &#x3D; _verfy_ac(self.private_key, _params)</span><br><span class="line">        return self.conn.get(uri, _params)</span><br></pre></td></tr></table></figure>

<h2 id="conf-py"><a href="#conf-py" class="headerlink" title="conf.py"></a><code>conf.py</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#-*- encoding: utf-8 -*-</span><br><span class="line">#配置公私钥&quot;&quot;&quot;</span><br><span class="line">public_key  &#x3D; &quot;at************************&quot;</span><br><span class="line">private_key &#x3D; &quot;e7***************&quot;</span><br><span class="line">#project_id &#x3D; &quot;******&quot; # 项目ID 请在Dashbord 上获取</span><br><span class="line"></span><br><span class="line">base_url    &#x3D; &quot;https:&#x2F;&#x2F;api.ucloud.cn&quot;</span><br></pre></td></tr></table></figure>


<h2 id="collect-uhost-price-py"><a href="#collect-uhost-price-py" class="headerlink" title="collect_uhost_price.py"></a>collect_uhost_price.py</h2><blockquote>
<p>通过查看机器示例，按付费方式查看机器价格。<br>具体查看<a href="https://docs.ucloud.cn/api/uhost-api/index">ucloud uhost API</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line"># author:fanquanqing</span><br><span class="line"># collect ucloud uhost price</span><br><span class="line">from sdk import UcloudApiClient</span><br><span class="line">from config import *</span><br><span class="line">from collections import Iterable</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#host_list &#x3D; []</span><br><span class="line"></span><br><span class="line"># 收集uhost信息</span><br><span class="line">def collect_uhost_info(Regions_list,ProjectId):</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    包含 hostname, ip, region, cpu, mem, diskspace, chargetype, count, ImageId, osname.</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    host_info_list &#x3D; []</span><br><span class="line">    for Region in Regions_list:</span><br><span class="line">        ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">        Parameters&#x3D;&#123;</span><br><span class="line">        &quot;Action&quot;:&quot;DescribeUHostInstance&quot;,</span><br><span class="line">        &quot;Region&quot;:Region,</span><br><span class="line">        &quot;ProjectId&quot;:ProjectId,</span><br><span class="line">        &quot;Limit&quot;:&quot;1000&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters);</span><br><span class="line">        length &#x3D; response[&#39;TotalCount&#39;]</span><br><span class="line">        for i in range(length):</span><br><span class="line">            host_info &#x3D; &#123;&#125;</span><br><span class="line">            #ImageId &#x3D; response[&quot;UHostSet&quot;][i][&quot;BasicImageId&quot;].encode(&quot;utf-8&quot;)</span><br><span class="line">            ChargeType &#x3D; response[&quot;UHostSet&quot;][i][&quot;ChargeType&quot;].encode(&quot;utf-8&quot;)</span><br><span class="line">            #host_info[&quot;Action&quot;] &#x3D; &quot;GetUHostInstancePrice&quot;</span><br><span class="line">            host_info[&quot;Region&quot;] &#x3D; Region</span><br><span class="line">            host_info[&quot;ImageId&quot;] &#x3D; &quot;uimage-kg0w4u&quot;</span><br><span class="line">            host_info[&quot;Hostname&quot;] &#x3D; response[&quot;UHostSet&quot;][i][&quot;Name&quot;]</span><br><span class="line">            host_info[&quot;CPU&quot;] &#x3D; response[&quot;UHostSet&quot;][i][&quot;CPU&quot;]</span><br><span class="line">            host_info[&quot;Memory&quot;] &#x3D; response[&quot;UHostSet&quot;][i][&quot;Memory&quot;]</span><br><span class="line"></span><br><span class="line">            if len(response[&quot;UHostSet&quot;][i][&quot;DiskSet&quot;]) &gt; 1:</span><br><span class="line">                host_info[&quot;DiskSpace&quot;] &#x3D; response[&quot;UHostSet&quot;][i][&quot;DiskSet&quot;][1][&quot;Size&quot;]</span><br><span class="line">            else:</span><br><span class="line">                host_info[&quot;DiskSpace&quot;]&#x3D;0</span><br><span class="line">            host_info[&quot;Count&quot;] &#x3D; 1</span><br><span class="line">            host_info[&quot;ChargeType&quot;] &#x3D; ChargeType</span><br><span class="line">            host_info[&quot;OsName&quot;] &#x3D; response[&quot;UHostSet&quot;][i][&quot;OsName&quot;].split()[0]</span><br><span class="line">            host_info[&quot;loaclIP&quot;] &#x3D; response[&quot;UHostSet&quot;][i][&quot;IPSet&quot;][0][&quot;IP&quot;]</span><br><span class="line">            if len(response[&quot;UHostSet&quot;][i][&quot;IPSet&quot;])&gt;1:</span><br><span class="line">                host_info[&quot;EIP&quot;]&#x3D;response[&quot;UHostSet&quot;][i][&quot;IPSet&quot;][1][&quot;IP&quot;]</span><br><span class="line">            else:</span><br><span class="line">                host_info[&quot;EIP&quot;]&#x3D;&quot;none&quot;</span><br><span class="line"></span><br><span class="line">            host_info_list.append(host_info)</span><br><span class="line">    #print host_info_list</span><br><span class="line">    return host_info_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#通过机器配置得到某一台机器价格</span><br><span class="line">def get_uhost_price(host_instance_info):</span><br><span class="line">    ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">    Parameters&#x3D; host_instance_info</span><br><span class="line">    response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">#    print json.dumps(response, sort_keys&#x3D;True, indent&#x3D;4, separators&#x3D;(&#39;,&#39;, &#39;: &#39;))</span><br><span class="line">    price &#x3D; float(response[&quot;PriceSet&quot;][0].values()[0])</span><br><span class="line">    return price</span><br><span class="line"></span><br><span class="line">#通过机器配置信息得到所有机器价格</span><br><span class="line">def get_all_uhost_price(host_info_list):</span><br><span class="line"></span><br><span class="line">    for host_info in host_info_list:</span><br><span class="line">        host_params&#x3D;&#123;&#125;</span><br><span class="line">        host_params[&quot;Action&quot;]&#x3D;&quot;GetUHostInstancePrice&quot;</span><br><span class="line">        host_params[&quot;ImageId&quot;]&#x3D;host_info[&quot;ImageId&quot;]</span><br><span class="line">        host_params[&quot;CPU&quot;]&#x3D;host_info[&quot;CPU&quot;]</span><br><span class="line">        host_params[&quot;Memory&quot;]&#x3D;host_info[&quot;Memory&quot;]</span><br><span class="line">        host_params[&quot;Count&quot;]&#x3D;host_info[&quot;Count&quot;]</span><br><span class="line">        host_params[&quot;DiskSpace&quot;]&#x3D;host_info[&quot;DiskSpace&quot;]</span><br><span class="line">        host_params[&quot;Region&quot;]&#x3D;&quot;cn-bj2&quot;</span><br><span class="line">        host_params[&quot;ChargeType&quot;]&#x3D;host_info[&quot;ChargeType&quot;]</span><br><span class="line">        if host_params[&quot;ChargeType&quot;]&#x3D;&#x3D;&quot;Year&quot;:</span><br><span class="line">            price &#x3D; get_uhost_price(host_params)</span><br><span class="line">        elif host_params[&quot;ChargeType&quot;]&#x3D;&#x3D;&quot;Month&quot;:</span><br><span class="line">            price &#x3D; get_uhost_price(host_params)*12</span><br><span class="line">        else:</span><br><span class="line">            price&#x3D;0</span><br><span class="line">            print &quot;有临时机器请排查。&quot;</span><br><span class="line">        host_info[&quot;Price&quot;]&#x3D;price</span><br><span class="line"></span><br><span class="line">    return host_info_list</span><br><span class="line"></span><br><span class="line">def collect_uhost_price(setting_info):</span><br><span class="line"></span><br><span class="line">    host_info_total &#x3D; []</span><br><span class="line">    for Projectname in setting_info:</span><br><span class="line">        for ProjectId in setting_info[Projectname]:</span><br><span class="line">            Regions_list &#x3D; setting_info[Projectname][ProjectId]</span><br><span class="line">            host_info_list &#x3D; collect_uhost_info(Regions_list,ProjectId)</span><br><span class="line">            project_host_list &#x3D; get_all_uhost_price(host_info_list)</span><br><span class="line">            host_info_total.extend(project_host_list)</span><br><span class="line">    return host_info_total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    host_info_list &#x3D; collect_uhost_info([&#39;cn-bj2&#39;,&#39;hk&#39;],&quot;org-oddm1w&quot;)</span><br><span class="line">    host_price_list &#x3D; get_all_uhost_price(host_info_list)</span><br><span class="line">    #print host_price_list</span><br></pre></td></tr></table></figure>

<h2 id="collect-eip-price-py"><a href="#collect-eip-price-py" class="headerlink" title="collect_eip_price.py"></a>collect_eip_price.py</h2><blockquote>
<p>收集弹性IP信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"># author:fanquanqing</span><br><span class="line"># collect ucloud eip price</span><br><span class="line">from sdk import UcloudApiClient</span><br><span class="line">from config import *</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"># 得到所有的EIP实例信息</span><br><span class="line">def get_eip_instance(Regions_list,ProjectId):</span><br><span class="line">    eip_all &#x3D; []</span><br><span class="line">    for Region in Regions_list:</span><br><span class="line">        ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">        Parameters&#x3D;&#123;&quot;Action&quot;:&quot;DescribeEIP&quot;, &quot;Region&quot;:Region, &quot;ProjectId&quot;:ProjectId&#125;</span><br><span class="line">        response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">        for eip in response[&#39;EIPSet&#39;]:</span><br><span class="line">            eip_instance &#x3D; &#123;&#125;</span><br><span class="line">            # 地域</span><br><span class="line">            eip_instance[&#39;Region&#39;]&#x3D;Region</span><br><span class="line">            # IP</span><br><span class="line">            eip_instance[&#39;IP&#39;]&#x3D;eip[&#39;EIPAddr&#39;][0][&#39;IP&#39;]</span><br><span class="line"></span><br><span class="line">            # 运营商线路</span><br><span class="line">            eip_instance[&#39;OperatorName&#39;]&#x3D;eip[&#39;EIPAddr&#39;][0][&#39;OperatorName&#39;].encode(&#39;utf-8&#39;)</span><br><span class="line">            # 带宽</span><br><span class="line">            eip_instance[&#39;Bandwidth&#39;]&#x3D;eip[&#39;Bandwidth&#39;]</span><br><span class="line">            # 付费周期</span><br><span class="line">            eip_instance[&#39;ChargeType&#39;]&#x3D;eip[&#39;ChargeType&#39;].encode(&#39;utf-8&#39;)</span><br><span class="line">            # 付费方式(是否绑定共享带宽)</span><br><span class="line">            eip_instance[&#39;PayMode&#39;]&#x3D;eip[&#39;PayMode&#39;].encode(&#39;utf-8&#39;)</span><br><span class="line">            eip_all.append(eip_instance)</span><br><span class="line"></span><br><span class="line">    return eip_all</span><br><span class="line">    #print json.dumps(response, sort_keys&#x3D;True, indent&#x3D;4, separators&#x3D;(&#39;,&#39;, &#39;: &#39;))</span><br><span class="line"></span><br><span class="line"># 查看单个EIP实例价格</span><br><span class="line">def get_eip_price(eip):</span><br><span class="line">    ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">    Parameters&#x3D;eip</span><br><span class="line">    response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">    #print response</span><br><span class="line">    price &#x3D; response[&#39;PriceSet&#39;][0][&#39;Price&#39;]</span><br><span class="line">    return price</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 获取所有EIP价格</span><br><span class="line">def get_all_eip_price(eip_all):</span><br><span class="line"></span><br><span class="line">    for eip_info in eip_all:</span><br><span class="line">        eip_params&#x3D;&#123;&#125;</span><br><span class="line">        eip_params[&#39;Action&#39;]&#x3D;&quot;GetEIPPrice&quot;</span><br><span class="line">        eip_params[&#39;Region&#39;]&#x3D;eip_info[&#39;Region&#39;]</span><br><span class="line">        eip_params[&#39;OperatorName&#39;]&#x3D;eip_info[&#39;OperatorName&#39;]</span><br><span class="line">        eip_params[&#39;Bandwidth&#39;]&#x3D;eip_info[&#39;Bandwidth&#39;]</span><br><span class="line">        eip_params[&#39;ChargeType&#39;]&#x3D;eip_info[&#39;ChargeType&#39;]</span><br><span class="line">        eip_params[&#39;PayMode&#39;]&#x3D;eip_info[&#39;PayMode&#39;]</span><br><span class="line">        if eip_params[&#39;ChargeType&#39;]&#x3D;&#x3D;&quot;Year&quot;:</span><br><span class="line">            price &#x3D; get_eip_price(eip_params)</span><br><span class="line">        elif eip_params[&#39;ChargeType&#39;]&#x3D;&#x3D;&quot;Month&quot;:</span><br><span class="line">            price &#x3D; get_eip_price(eip_params)*12</span><br><span class="line">        else:</span><br><span class="line">            price&#x3D;0</span><br><span class="line">            print &quot;有临时EIP请排查&quot;</span><br><span class="line">        eip_info[&quot;Price&quot;]&#x3D;price</span><br><span class="line">    return eip_all</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def collect_eip_price(setting_info):</span><br><span class="line">    eip_info_total &#x3D; []</span><br><span class="line">    for Projectname in setting_info:</span><br><span class="line">        for ProjectId in setting_info[Projectname]:</span><br><span class="line">            Regions_list &#x3D; setting_info[Projectname][ProjectId]</span><br><span class="line">            eip_all&#x3D;get_eip_instance(Regions_list,ProjectId)</span><br><span class="line">            price_all&#x3D;get_all_eip_price(eip_all)</span><br><span class="line">            eip_info_total.extend(price_all)</span><br><span class="line">    #print eip_info_total</span><br><span class="line">    return eip_info_total</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    collect_eip_price(&#123;&quot;chunyu&quot;:&#123;&quot;org-oddm1w&quot;:[&#39;cn-bj2&#39;,&#39;hk&#39;]&#125;, &quot;uhs&quot;:&#123;&quot;org-shbbct&quot;:[&quot;cn-bj2&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="collect-udisk-price-py"><a href="#collect-udisk-price-py" class="headerlink" title="collect_udisk_price.py"></a>collect_udisk_price.py</h2><blockquote>
<p>收集云硬盘信息，这个只是取到实例自己手动算的价格</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line"># author: fanquanqing</span><br><span class="line"># 收集ucloud云硬盘信息 及价格</span><br><span class="line"></span><br><span class="line">from sdk import UcloudApiClient</span><br><span class="line">from config import *</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"># 获取udisk 信息</span><br><span class="line">def get_udisk_info(Regions_list,ProjectId):</span><br><span class="line">    udisk_list &#x3D; []</span><br><span class="line">    for Region in Regions_list:</span><br><span class="line">        ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">        Parameters&#x3D;&#123;&quot;Action&quot;:&quot;DescribeUDisk&quot;, &quot;Region&quot;:Region, &quot;ProjectId&quot;:ProjectId&#125;</span><br><span class="line">        response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">        for udisk in response[&#39;DataSet&#39;]:</span><br><span class="line">            udisk_dic &#x3D; &#123;&#125;</span><br><span class="line">            udisk_dic[&#39;Region&#39;] &#x3D; Region</span><br><span class="line">            #udisk_dic[&#39;Action&#39;] &#x3D; &quot;DescribeUDiskPrice&quot;</span><br><span class="line">            udisk_dic[&#39;Size&#39;] &#x3D; udisk[&#39;Size&#39;]</span><br><span class="line">            udisk_dic[&#39;ChargeType&#39;] &#x3D; udisk[&#39;ChargeType&#39;].encode(&#39;utf-8&#39;)</span><br><span class="line">            udisk_dic[&#39;UHostName&#39;] &#x3D; udisk[&#39;UHostName&#39;]</span><br><span class="line">            udisk_dic[&#39;Quantity&#39;] &#x3D; 1</span><br><span class="line">            udisk_dic[&#39;Zone&#39;] &#x3D; &quot;cn-bj2-02&quot;</span><br><span class="line">            udisk_list.append(udisk_dic)</span><br><span class="line">    return udisk_list</span><br><span class="line"></span><br><span class="line"># 通过udisk信息获取价格</span><br><span class="line">def get_udisk_price(udisk_list):</span><br><span class="line">    for udisk in udisk_list:</span><br><span class="line">        ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">        udisk_params&#x3D;&#123;&#125;</span><br><span class="line">        udisk_params[&#39;Action&#39;]&#x3D;&quot;DescribeUDiskPrice&quot;</span><br><span class="line">        udisk_params[&#39;Region&#39;]&#x3D;udisk[&#39;Region&#39;]</span><br><span class="line">        udisk_params[&#39;Size&#39;]&#x3D;udisk[&#39;Size&#39;]</span><br><span class="line">        udisk_params[&#39;ChargeType&#39;]&#x3D;udisk[&#39;ChargeType&#39;]</span><br><span class="line">        udisk_params[&#39;Quantity&#39;]&#x3D;udisk[&#39;Quantity&#39;]</span><br><span class="line">        udisk_params[&#39;Zone&#39;]&#x3D;udisk[&#39;Zone&#39;]</span><br><span class="line">        Parameters &#x3D; udisk_params</span><br><span class="line">        response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">        if udisk_params[&#39;ChargeType&#39;]&#x3D;&#x3D;&quot;Year&quot;:</span><br><span class="line">            price &#x3D; response[&#39;DataSet&#39;][0][&#39;Price&#39;]&#x2F;100</span><br><span class="line">        elif udisk_params[&#39;ChargeType&#39;]&#x3D;&#x3D;&quot;Month&quot;:</span><br><span class="line">            price &#x3D; response[&#39;DataSet&#39;][0][&#39;Price&#39;]&#x2F;10</span><br><span class="line">        else:</span><br><span class="line">            print &quot;有付费方式异常的云硬盘，请排查。&quot;</span><br><span class="line">        udisk[&quot;Price&quot;]&#x3D;price</span><br><span class="line">    return udisk_list</span><br><span class="line"></span><br><span class="line"># 通过付费周期获取udisk价格</span><br><span class="line">def collect_udisk_price(setting_info):</span><br><span class="line">    udisk_price_info &#x3D; []</span><br><span class="line">    for Projectname in setting_info:</span><br><span class="line">        for ProjectId in setting_info[Projectname]:</span><br><span class="line">            Regions_list &#x3D; setting_info[Projectname][ProjectId]</span><br><span class="line">            udisk_list &#x3D; get_udisk_info(Regions_list,ProjectId)</span><br><span class="line">            udisk_price_info.extend(get_udisk_price(udisk_list))</span><br><span class="line">    return udisk_price_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    collect_udisk_price(&#123;&quot;chunyu&quot;:&#123;&quot;org-oddm1w&quot;:[&#39;cn-bj2&#39;,&#39;hk&#39;]&#125;, &quot;uhs&quot;:&#123;&quot;org-shbbct&quot;:[&quot;cn-bj2&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="collect-sharebandwidth-price-py"><a href="#collect-sharebandwidth-price-py" class="headerlink" title="collect_sharebandwidth_price.py"></a>collect_sharebandwidth_price.py</h2><blockquote>
<p>收集共享带宽信息,因为没有计算价格的API这个价格也是手动算的。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">#author fanquanqing</span><br><span class="line">#收集共享带宽信息获取每年消费情况</span><br><span class="line">from sdk import UcloudApiClient</span><br><span class="line">from config import *</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">def get_bandwidth_info(Regions_list,ProjectId):</span><br><span class="line">    bandwidth &#x3D; []</span><br><span class="line">    for Region in Regions_list:</span><br><span class="line"></span><br><span class="line">        ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">        Parameters&#x3D;&#123;&quot;Action&quot;:&quot;DescribeShareBandwidth&quot;,&quot;Region&quot;:Region,&quot;ProjectId&quot;:ProjectId&#125;</span><br><span class="line">        response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">        #print response</span><br><span class="line">        for bw in response[&#39;DataSet&#39;]:</span><br><span class="line">            bw_instance &#x3D; &#123;&#125;</span><br><span class="line">            bw_instance[&#39;ShareBandwidth&#39;] &#x3D;  bw[&#39;ShareBandwidth&#39;]</span><br><span class="line">            bw_instance[&#39;ChargeType&#39;] &#x3D; bw[&#39;ChargeType&#39;]</span><br><span class="line">            bw_instance[&#39;Name&#39;]&#x3D;bw[&#39;Name&#39;]</span><br><span class="line">            bandwidth.append(bw_instance)</span><br><span class="line">    return bandwidth</span><br><span class="line">#   print json.dumps(response, sort_keys&#x3D;True, indent&#x3D;4, separators&#x3D;(&#39;,&#39;, &#39;: &#39;))</span><br><span class="line"></span><br><span class="line">def get_price(bandwidth):</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    价格计算说明:ucloud没有提供API查询共享带宽价格，所有的共享带宽价格都是90&#x2F;M&#x2F;月 月付*12,年付*10</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    price_list &#x3D; []</span><br><span class="line">    for bw in bandwidth:</span><br><span class="line">        if bw[&#39;ChargeType&#39;]&#x3D;&#x3D;&quot;Month&quot;:</span><br><span class="line">            price &#x3D; bw[&#39;ShareBandwidth&#39;]*90*12</span><br><span class="line">            bw[&quot;Price&quot;]&#x3D;price</span><br><span class="line">        else:</span><br><span class="line">            price &#x3D; bw[&#39;ShareBandwidrh&#39;]</span><br><span class="line">            bw[&quot;Price&quot;]&#x3D;price</span><br><span class="line">    return bandwidth</span><br><span class="line"></span><br><span class="line">def collect_sharebandwidth_price(setting_info):</span><br><span class="line">    bw_price_info &#x3D; []</span><br><span class="line">    for Projectname in setting_info:</span><br><span class="line">        for ProjectId in setting_info[Projectname]:</span><br><span class="line">            Regions_list &#x3D; setting_info[Projectname][ProjectId]</span><br><span class="line">            bw_info &#x3D; get_bandwidth_info(Regions_list,ProjectId)</span><br><span class="line">            bw_price_info.extend(get_price(bw_info))</span><br><span class="line">    #print bw_price_info</span><br><span class="line">    return bw_price_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    collect_sharebandwidth_price(&#123;&quot;chunyu&quot;:&#123;&quot;org-oddm1w&quot;:[&#39;cn-bj2&#39;,&#39;hk&#39;]&#125;, &quot;uhs&quot;:&#123;&quot;org-shbbct&quot;:[&quot;cn-bj2&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="get-all-price-py"><a href="#get-all-price-py" class="headerlink" title="get_all_price.py"></a>get_all_price.py</h2><blockquote>
<p>给各实例价格求和，发送到influxdb。可以每天跑一下cron更新下内容。<strong>里面发送的influxDB是事先封装好的包直接导入的，并不是官方包</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line"># author: fanquanqing</span><br><span class="line">#import datatime</span><br><span class="line">from collect_eip_price import collect_eip_price</span><br><span class="line">from collect_uhost_price import collect_uhost_price</span><br><span class="line">from collect_sharebandwidth_price import collect_sharebandwidth_price</span><br><span class="line">from collect_udisk_price import collect_udisk_price</span><br><span class="line">from op_tools.api_influxdb import write_data_to_influxdb</span><br><span class="line"></span><br><span class="line">def get_price(setting_info):</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    各个实例price求和,并把实例信息发送到influxdb</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    eip_price&#x3D;0</span><br><span class="line">    uhost_price&#x3D;0</span><br><span class="line">    sharebw_price&#x3D;0</span><br><span class="line">    udisk_price&#x3D;0</span><br><span class="line">    eip_price_info_list &#x3D; collect_eip_price(setting_info)</span><br><span class="line">    for eip_info in eip_price_info_list:</span><br><span class="line">        eip_headers &#x3D; eip_info.keys()</span><br><span class="line">        eip_rows &#x3D; []</span><br><span class="line">        eip_rows.append(eip_info.values())</span><br><span class="line">        #print eip_headers, eip_rows</span><br><span class="line">        # 发送EIP数据到influxdb</span><br><span class="line">        write_data_to_influxdb(&#39;EIP_info_daliy&#39;, eip_headers, eip_rows, [&#39;IP&#39;, &#39;OperatorName&#39;, &#39;ChargeType&#39;])</span><br><span class="line">        eip_price +&#x3D; round(eip_info[&#39;Price&#39;])</span><br><span class="line"></span><br><span class="line">    uhost_price_info_list &#x3D; collect_uhost_price(setting_info)</span><br><span class="line">    for uhost_info in uhost_price_info_list:</span><br><span class="line">        uhost_headers&#x3D;uhost_info.keys()</span><br><span class="line">        uhost_rows&#x3D;[]</span><br><span class="line">        uhost_rows.append(uhost_info.values())</span><br><span class="line">        #print uhost_headers, uhost_rows</span><br><span class="line">        # 发送云主机信息到influxdb</span><br><span class="line">        write_data_to_influxdb(&#39;Uhost_info_daliy&#39;, uhost_headers, uhost_rows, [&#39;Hostname&#39;,&#39;ChargeType&#39;])</span><br><span class="line">        uhost_price +&#x3D; round(uhost_info[&#39;Price&#39;])</span><br><span class="line"></span><br><span class="line">    sharebandwidth_info_list &#x3D; collect_sharebandwidth_price(setting_info)</span><br><span class="line">    for sharebandwidth_info in sharebandwidth_info_list:</span><br><span class="line">        sharebw_headers&#x3D;sharebandwidth_info.keys()</span><br><span class="line">        sharebw_rows&#x3D;[]</span><br><span class="line">        sharebw_rows.append(sharebandwidth_info.values())</span><br><span class="line">        #print sharebw_headers, sharebw_rows</span><br><span class="line">        # 发送共享带宽信息到influxdb</span><br><span class="line">        write_data_to_influxdb(&#39;ShareBandwidth_info_daliy&#39;,sharebw_headers,sharebw_rows,[])</span><br><span class="line">        sharebw_price +&#x3D; round(sharebandwidth_info[&#39;Price&#39;])</span><br><span class="line"></span><br><span class="line">    udisk_info_list&#x3D;collect_udisk_price(setting_info)</span><br><span class="line">    for udisk_info in udisk_info_list:</span><br><span class="line">        udisk_headers&#x3D;udisk_info.keys()</span><br><span class="line">        udisk_rows&#x3D;[]</span><br><span class="line">        udisk_rows.append(udisk_info.values())</span><br><span class="line">        #print udisk_headers, udisk_rows</span><br><span class="line">        write_data_to_influxdb(&#39;Udisk_info_daliy&#39;, udisk_headers,udisk_rows,[&#39;UHostName&#39;,&#39;Region&#39;])</span><br><span class="line">        udisk_price +&#x3D; round(udisk_info[&#39;Price&#39;])</span><br><span class="line">    # 托管机房价格</span><br><span class="line">    physical_price &#x3D; get_physical_host_price()</span><br><span class="line">    total_price&#x3D;eip_price+uhost_price+sharebw_price+udisk_price+physical_price</span><br><span class="line">    # 价格列表</span><br><span class="line">    price_list&#x3D;[eip_price,uhost_price,sharebw_price,udisk_price,total_price]</span><br><span class="line">    price_headers&#x3D;[&#39;eip_price&#39;,&#39;uhost_price&#39;,&#39;sharebw_price&#39;,&#39;udisk_price&#39;,&#39;total_price&#39;]</span><br><span class="line">    price_rows&#x3D;[]</span><br><span class="line">    price_rows.append(price_list)</span><br><span class="line">    write_data_to_influxdb(&#39;Ucloud_price_total_daliy&#39;,price_headers,price_rows,[])</span><br><span class="line"></span><br><span class="line">    #print uhost_price</span><br><span class="line">    return uhost_price</span><br><span class="line"></span><br><span class="line"># 托管机器价格(两个机柜一个10M外网)</span><br><span class="line">def get_physical_host_price():</span><br><span class="line">    host_price &#x3D; 9000*2*12</span><br><span class="line">    tg_cloud_switch_port_price &#x3D; (288*2+217)*12</span><br><span class="line">    tg_bandwidth_price &#x3D; 10*90*12</span><br><span class="line">    physical_price &#x3D; host_price+tg_bandwidth_price+tg_cloud_switch_port_price</span><br><span class="line">    return physical_price</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    # 可用区列表</span><br><span class="line">    #Regions_list &#x3D; [&#39;cn-bj2&#39;,&#39;hk&#39;]</span><br><span class="line">    # 项目ID列表</span><br><span class="line">    #Project_Id_list &#x3D; [&#39;org-shbbct&#39;,&#39;org-oddm1w&#39;]</span><br><span class="line">    # 项目ID对应关系</span><br><span class="line">    setting_info &#x3D; &#123;&quot;chunyu&quot;:&#123;&quot;org-oddm1w&quot;:[&#39;cn-bj2&#39;,&#39;hk&#39;]&#125;, &quot;uhs&quot;:&#123;&quot;org-shbbct&quot;:[&quot;cn-bj2&quot;]&#125;&#125;</span><br><span class="line">    get_price(setting_info)</span><br></pre></td></tr></table></figure>

<h2 id="grafana效果展示"><a href="#grafana效果展示" class="headerlink" title="grafana效果展示"></a>grafana效果展示</h2><blockquote>
<p>grafana跟influxDB配合的非常好，设置也非常简单。下面我在下面放几张效果图。</p>
</blockquote>
<p><strong>简单查询语句</strong><br><img src="http://or2jd66dq.bkt.clouddn.com/grafana_influxdb.png" alt=""></p>
<p><strong>table展示效果</strong><br><img src="http://or2jd66dq.bkt.clouddn.com/grafana_ucloud_eip.png" alt=""></p>
<p><strong>价格图展示</strong><br><img src="http://or2jd66dq.bkt.clouddn.com/grafana_ucloud_price.png" alt=""></p>
<h2 id="获取实时带宽信息并发送报警到钉钉"><a href="#获取实时带宽信息并发送报警到钉钉" class="headerlink" title="获取实时带宽信息并发送报警到钉钉"></a>获取实时带宽信息并发送报警到钉钉</h2><blockquote>
<p>这个跟上面的脚本没有关联，只是获取实时带宽使用量的报警脚本。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from sdk import UcloudApiClient</span><br><span class="line">from config import *</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line">import urllib2</span><br><span class="line">import time</span><br><span class="line">#from op_tools import falcon</span><br><span class="line"></span><br><span class="line">#实例化 API 句柄</span><br><span class="line">localtime &#x3D; time.asctime( time.localtime(time.time()) )</span><br><span class="line"></span><br><span class="line">def get_eip_info():</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    获取EIP对应的主机名，以及EIP信息返回</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    arg_length &#x3D; len(sys.argv)</span><br><span class="line">    ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">    Parameters&#x3D;&#123;&quot;Action&quot;:&quot;DescribeEIP&quot;, &quot;Region&quot;:&quot;cn-bj2&quot;&#125;</span><br><span class="line">    response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">    eip_info_list &#x3D; response[&#39;EIPSet&#39;]</span><br><span class="line">    eip_dic &#x3D; &#123;&#125;</span><br><span class="line">    for eip_info in eip_info_list:</span><br><span class="line">        # EIP绑定主机名</span><br><span class="line">        eip_host &#x3D; eip_info[&#39;Resource&#39;][&#39;ResourceName&#39;]</span><br><span class="line">        eip_ip &#x3D; eip_info[&#39;EIPAddr&#39;][0][&#39;IP&#39;].encode(&#39;utf-8&#39;)</span><br><span class="line">        eip_id &#x3D; eip_info[&#39;EIPId&#39;]</span><br><span class="line">        dic &#x3D; &#123;&#125;</span><br><span class="line">        dic[eip_ip] &#x3D; eip_id</span><br><span class="line">        #print &quot;eip_host:%s,dic:%s&quot; % (eip_host,dic)</span><br><span class="line">        eip_dic[eip_host] &#x3D; dic</span><br><span class="line">    #print len(eip_dic)</span><br><span class="line">    eip_dic[&#39;nginx-online1&#39;] &#x3D; &#123;&#39;106.75.28.177&#39;: u&#39;eip-00gv0l&#39;&#125;</span><br><span class="line">    return eip_dic</span><br><span class="line"></span><br><span class="line">def get_eip_usage(eip_dic):</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    获取每个EIP的实时用量(要求EIPid),</span><br><span class="line">    return list:[&#123;ip:usage&#125;...]</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    eip_usage_dic &#x3D; &#123;&#125;</span><br><span class="line">    for eip_host in eip_dic:</span><br><span class="line">        #eip_useage_dic &#x3D; &#123;&#125;</span><br><span class="line">        eip_id&#x3D;eip_dic[eip_host].values()[0].encode(&quot;utf-8&quot;)</span><br><span class="line">        #print eip_id</span><br><span class="line">        ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">        Parameters&#x3D;&#123;</span><br><span class="line">                    &quot;Action&quot;:&quot;DescribeBandwidthUsage&quot;,</span><br><span class="line">                    &quot;Region&quot;:&quot;cn-bj2&quot;,</span><br><span class="line">                    &quot;EIPIds.1&quot;:eip_id,</span><br><span class="line">                &#125;</span><br><span class="line">        response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters);</span><br><span class="line">        #print json.dumps(response, sort_keys&#x3D;True, indent&#x3D;4, separators&#x3D;(&#39;,&#39;, &#39;: &#39;))</span><br><span class="line">        #print response</span><br><span class="line">        eip_usage &#x3D; response[&#39;EIPSet&#39;][0][&#39;CurBandwidth&#39;]</span><br><span class="line">        eip_usage_dic[eip_host]&#x3D;eip_usage</span><br><span class="line">        #eip_usage_list.append(eip_useage_dic)</span><br><span class="line">    return eip_usage_dic</span><br><span class="line"></span><br><span class="line">def sendto_falcon(eip_usage_list):</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    报警发送到falcon</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    collect_step &#x3D; 60</span><br><span class="line">    counter_type &#x3D; falcon.CounterType.GAUGE</span><br><span class="line">    metric &#x3D; &quot;bandwidthusage&quot;</span><br><span class="line">    for eip_usage in eip_usage_list:</span><br><span class="line">        tags&#x3D;&quot;host&#x3D;&quot; + eip_usage.keys()[0]</span><br><span class="line">        value&#x3D;eip_usage.values()[0]</span><br><span class="line">        #print value</span><br><span class="line"></span><br><span class="line">def get_sharebw_info():</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    获取共享带宽的带宽大小，以及所包含的EIP,</span><br><span class="line">    return list:[&#123;&#39;eiplist&#39;:[ip1,ip1],&#39;bandwidth&#39;:20&#125;...]</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line"></span><br><span class="line">    ApiClient &#x3D; UcloudApiClient(base_url, public_key, private_key)</span><br><span class="line">    Parameters&#x3D;&#123;&quot;Action&quot;:&quot;DescribeShareBandwidth&quot;, &quot;Region&quot;:&quot;cn-bj2&quot;&#125;</span><br><span class="line">    response &#x3D; ApiClient.get(&quot;&#x2F;&quot;, Parameters );</span><br><span class="line">    #print json.dumps(response, sort_keys&#x3D;True, indent&#x3D;4, separators&#x3D;(&#39;,&#39;, &#39;: &#39;))</span><br><span class="line">    share_bw_list &#x3D; response[&#39;DataSet&#39;]</span><br><span class="line">    share_bw_info &#x3D; []</span><br><span class="line">    for share_bw in share_bw_list:</span><br><span class="line">        share_bw_dic &#x3D; &#123;&#125;</span><br><span class="line">        bandwidth &#x3D; share_bw[&#39;ShareBandwidth&#39;]</span><br><span class="line">        eip_list &#x3D; []</span><br><span class="line">        for eip_dic in share_bw[&#39;EIPSet&#39;]:</span><br><span class="line">            ip &#x3D; eip_dic[&#39;EIPAddr&#39;][0][&#39;IP&#39;]</span><br><span class="line">            eip_list.append(ip)</span><br><span class="line">        share_bw_dic[&#39;bandwidth&#39;]&#x3D;bandwidth</span><br><span class="line">        share_bw_dic[&#39;eiplist&#39;]&#x3D;eip_list</span><br><span class="line">        share_bw_info.append(share_bw_dic)</span><br><span class="line">    return share_bw_info</span><br><span class="line"></span><br><span class="line">def sum():</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    返回比值，并简单记录log到&#x2F;var&#x2F;log&#x2F;ubandwidth.log</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    eip_dic &#x3D; get_eip_info()</span><br><span class="line">    #print eip_dic</span><br><span class="line">    eip_to_host &#x3D; &#123;&#125;</span><br><span class="line">    # 通过eip_dic获取IP-host对此应关系dic</span><br><span class="line">    for host in eip_dic:</span><br><span class="line">        eip &#x3D; eip_dic[host].keys()[0]</span><br><span class="line">        eip_to_host[eip]&#x3D;host</span><br><span class="line">    #print eip_to_host</span><br><span class="line">    eip_usage_dic &#x3D; get_eip_usage(eip_dic)</span><br><span class="line">    #print eip_usage_dic</span><br><span class="line">    share_bw_info &#x3D; get_sharebw_info()</span><br><span class="line">    #print share_bw_info</span><br><span class="line">    #各带宽和与带宽比值</span><br><span class="line">    ratios &#x3D; &#123;&#125;</span><br><span class="line">    for share_bandwidth in share_bw_info:</span><br><span class="line">        bandwidth &#x3D; share_bandwidth[&#39;bandwidth&#39;]</span><br><span class="line">        sum &#x3D; 0</span><br><span class="line">        for eip in share_bandwidth[&#39;eiplist&#39;]:</span><br><span class="line">            host &#x3D; eip_to_host[eip]</span><br><span class="line">            usage &#x3D; eip_usage_dic[host]</span><br><span class="line">            sum +&#x3D; usage</span><br><span class="line">        #带宽用量与带宽的比值</span><br><span class="line">        ratio &#x3D; sum&#x2F;bandwidth</span><br><span class="line">        parts &#x3D; [str(bandwidth),str(sum),str(ratio)]</span><br><span class="line">        log &#x3D;localtime + &#39; &#39; + &#39;,&#39;.join(parts) + &#39;\n&#39;</span><br><span class="line">        with open(&#39;&#x2F;var&#x2F;log&#x2F;ubandwidth.log&#39;,&#39;a&#39;) as f:</span><br><span class="line">            f.write(log)</span><br><span class="line">            f.close()</span><br><span class="line"></span><br><span class="line">        ratios[bandwidth]&#x3D;ratio</span><br><span class="line"></span><br><span class="line">    return ratios</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def send_to_dingtalk(content):</span><br><span class="line"></span><br><span class="line">    url &#x3D; &quot;https:&#x2F;&#x2F;oapi.dingtalk.com&#x2F;robot&#x2F;send?access_token&#x3D;17cf865229a63452ff411243b53d64949d5a54b1ee8774e20e1ec7d4c5d60f43&quot;</span><br><span class="line">    #con&#x3D;&#123;&quot;msgtype&quot;:&quot;text&quot;,&quot;text&quot;:&#123;&quot;content&quot;:content&#125;,&quot;isAtAll&quot;: &quot;true&quot;&#125;</span><br><span class="line">    con&#x3D;&#123;&quot;msgtype&quot;:&quot;markdown&quot;,&quot;markdown&quot;:&#123;&quot;title&quot;:&quot;ucloud共享带宽报警&quot;,&quot;text&quot;:content&#125;,&quot;isAtAll&quot;: &quot;ture&quot;&#125;</span><br><span class="line">    jd&#x3D;json.dumps(con)</span><br><span class="line">    req&#x3D;urllib2.Request(url,jd)</span><br><span class="line">    req.add_header(&#39;Content-Type&#39;, &#39;application&#x2F;json&#39;)</span><br><span class="line">    response&#x3D;urllib2.urlopen(req)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    ratios&#x3D;sum()</span><br><span class="line">    localtime &#x3D; time.asctime( time.localtime(time.time()) )</span><br><span class="line">    for bw in ratios:</span><br><span class="line">        if ratios[bw] &gt; 0.8:</span><br><span class="line">            content &#x3D; u&quot;# **ucloud共享带宽报警** - %d兆那个。。。\n\n - 用量超过百分之80 \n - **值**:%f \n &gt; [请排查...](https:&#x2F;&#x2F;console.ucloud.cn&#x2F;unet&#x2F;sharebandwidth)&quot; % (bw,ratios[bw])</span><br><span class="line">            send_to_dingtalk(content)</span><br></pre></td></tr></table></figure>





      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/08/nginx%E4%B9%8Blocation-upstream-rewrite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/08/nginx%E4%B9%8Blocation-upstream-rewrite/" class="post-title-link" itemprop="url">nginx之location,upstream,rewrite</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-08 14:19:45" itemprop="dateCreated datePublished" datetime="2017-07-08T14:19:45+08:00">2017-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>nginx配置第三篇，<a href="https://fanquqi.github.io/2017/07/06/nginx%E4%B9%8B%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">nginx安装配置</a>中讲了很多基础配置，这次讲一下具体的操作配置。</p>
</blockquote>
<h2 id="location配置"><a href="#location配置" class="headerlink" title="location配置"></a>location配置</h2><blockquote>
<p>location模块工作在虚拟主机server之下，对URL进行匹配，如果匹配成功就按照该location之中写的语句进行操作。</p>
</blockquote>
<p><strong>语法</strong> </p>
<p>location [=|<del>|</del>*|^~] /uri/ { … }</p>
<p><strong>匹配规则</strong></p>
<table>
<thead>
<tr>
<th align="left">模式</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">location = /uri</td>
<td align="center">= 表示精确匹配，只有完全匹配上才能生效。</td>
</tr>
<tr>
<td align="left">location ^~ /uri</td>
<td align="center">^~ 开头对URL路径进行前缀匹配，并且在正则之前。</td>
</tr>
<tr>
<td align="left">location ~ pattern</td>
<td align="center">区分大小写的正则匹配</td>
</tr>
<tr>
<td align="left">location ~* pattern</td>
<td align="center">不区分大小写的正则匹配</td>
</tr>
<tr>
<td align="left">location /uri</td>
<td align="center">不带任何修饰符，也表示前缀匹配，但是在正则匹配之后</td>
</tr>
<tr>
<td align="left">location /</td>
<td align="center">通用匹配，任何未匹配到其它location的请求都会匹配到，相当于switch中的default</td>
</tr>
</tbody></table>
<p>&emsp;&emsp;那么如果我们在一个虚拟主机下边写了很多location 规则，哪一个先匹配哪一个后匹配呢？<br>是这样的。<br>nginx会根据模糊程度排序的</p>
<ul>
<li>首先精确匹配 =</li>
<li>其次前缀匹配 ^~</li>
<li>其次是按文件中顺序的正则匹配</li>
<li>然后匹配不带任何修饰的前缀匹配。</li>
<li>最后是交给 / 通用匹配</li>
<li>当有匹配成功时候，停止匹配，按当前匹配规则处理请求</li>
</ul>
<h2 id="upstream"><a href="#upstream" class="headerlink" title="upstream"></a>upstream</h2><blockquote>
<p>负载均衡模块,负责根据配置合理分流到各个代理节点，而且自带后端节点健康检查（需要自己通过proxy_read_timeout指令和proxy_next_upstream指令配置）</p>
</blockquote>
<p><a href="http://nolinux.blog.51cto.com/4824967/1594029">参考文章</a><br><strong>语法</strong> <code>upstream name {server ip:port 状态}</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream name &#123;</span><br><span class="line">        </span><br><span class="line">        [ip_hash;]</span><br><span class="line">        server ip:port [weight&#x3D;n];</span><br><span class="line">        server ip:port [weight&#x3D;n];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name   www.xxx.com; </span><br><span class="line"></span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;name;</span><br><span class="line">    或者</span><br><span class="line">    uwsgi_pass </span><br><span class="line">    或者</span><br><span class="line">    fast_cgi_pass</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上下文 http server location </p>
<p>负载均衡策略: </p>
<ul>
<li>轮询(默认)</li>
<li>设置权重(weight)</li>
<li>ip_hash(每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。)</li>
</ul>
<p>其次还可以定义状态</p>
<ul>
<li>down 表示单前的server暂时不参与负载</li>
<li>weight 默认为1.weight越大，负载的权重就越大。</li>
<li>max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误</li>
<li>fail_timeout:max_fails次失败后，暂停的时间。</li>
<li>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</li>
</ul>
<h3 id="负载均衡后端节点健康检查"><a href="#负载均衡后端节点健康检查" class="headerlink" title="负载均衡后端节点健康检查"></a>负载均衡后端节点健康检查</h3><p>&emsp;&emsp;严格来说，nginx自带是没有针对负载均衡后端节点的健康检查的，但是可以通过默认自带的ngx_http_proxy_module.<br>  模块和ngx_http_upstream_module模块中的相关指令来完成当后端节点出现故障时，自动切换到健康节点来提供访问。</p>
<p>这里学习下ngx_http_proxy_module 模块中的 <code>proxy_connect_timeout</code> 指令、<code>proxy_read_timeout</code>指令和<code>proxy_next_upstream</code>指令</p>
<p><strong>设置与后端服务器建立连接的超时时间。</strong> 应该注意这个超时一般不可能大于75秒。</p>
<pre><code>proxy_connect_timeout 60s;</code></pre><p><strong>设置从后端服务器读取响应的超时</strong></p>
<pre><code>proxy_read_timeout 60s;</code></pre><p><strong>指定在何种情况下一个失败的请求应该被发送到下一台后端服务节点</strong></p>
<pre><code>proxy_next_upstream error timeout;</code></pre><p><code>error</code>      和后端服务器建立连接时，或者向后端服务器发送请求时，或者从后端服务器接收响应头时，出现错误</p>
<p><code>timeout</code>    和后端服务器建立连接时，或者向后端服务器发送请求时，或者从后端服务器接收响应头时，出现超时</p>
<p><code>invalid_header</code>  后端服务器返回空响应或者非法响应头</p>
<p><code>http_500</code>    后端服务器返回的响应状态码为500</p>
<p><code>http_502</code>    后端服务器返回的响应状态码为502</p>
<p><code>http_503</code>    后端服务器返回的响应状态码为503</p>
<p><code>http_504</code>    后端服务器返回的响应状态码为504</p>
<p><code>http_404</code>    后端服务器返回的响应状态码为404</p>
<p><code>off</code>         停止将请求发送给下一台后端服务器</p>
<p>&emsp;&emsp;还可以通过tengine来实现，淘宝技术团队开发的<code>nginx_upstream_check_module</code>模块来实现。<br>如果没有使用tengine需要打补丁。<br>配置起来比上述方法简单一些。<a href="http://tengine.taobao.org/document_cn/http_upstream_check_cn.html">参考地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream cluster1 &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 192.168.0.1:80;</span><br><span class="line">        server 192.168.0.2:80;</span><br><span class="line">        check interval&#x3D;3000 rise&#x3D;2 fall&#x3D;5 timeout&#x3D;1000 type&#x3D;http;</span><br><span class="line">        check_http_send &quot;HEAD &#x2F; HTTP&#x2F;1.0\r\n\r\n&quot;;</span><br><span class="line">        check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line">    upstream cluster2 &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 192.168.0.3:80;</span><br><span class="line">        server 192.168.0.4:80;</span><br><span class="line">        check interval&#x3D;3000 rise&#x3D;2 fall&#x3D;5 timeout&#x3D;1000 type&#x3D;http;</span><br><span class="line">        check_keepalive_requests 100;</span><br><span class="line">        check_http_send &quot;HEAD &#x2F; HTTP&#x2F;1.1\r\nConnection: keep-alive\r\n\r\n&quot;;</span><br><span class="line">        check_http_expect_alive http_2xx http_3xx;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;上面配置的意思是，对name这个负载均衡条目中的所有节点，每个3秒检测一次，请求2次正常则标记 realserver状态为up，如果检测 5 次都失败，则标记 realserver的状态为down，超时时间为1秒。</p>
<ul>
<li>interval：向后端发送的健康检查包的间隔。</li>
<li>fall(fall_count): 如果连续失败次数达到fall_count，服务器就被认为是down。</li>
<li>rise(rise_count): 如果连续成功次数达到rise_count，服务器就被认为是up。</li>
<li>timeout: 后端健康请求的超时时间。</li>
<li>type：健康检查包的类型，现在支持以下多种类型<ul>
<li>tcp：简单的tcp连接，如果连接成功，就说明后端正常。</li>
<li>ssl_hello：发送一个初始的SSL hello包并接受服务器的SSL hello包。</li>
<li>http：发送HTTP请求，通过后端的回复包的状态来判断后端是否存活。</li>
<li>mysql: 向mysql服务器连接，通过接收服务器的greeting包来判断后端是否存活。</li>
<li>ajp：向后端发送AJP协议的Cping包，通过接收Cpong包来判断后端是否存活。</li>
</ul>
</li>
</ul>
<p><strong>check_keepalive_requests</strong></p>
<p>&emsp;&emsp;该指令可以配置一个连接发送的请求数，其默认值为1，表示Tengine完成1次请求后即关闭连接。</p>
<p><strong>check_http_send</strong></p>
<p>&emsp;&emsp;该指令可以配置http健康检查包发送的请求内容。为了减少传输数据量，推荐采用”HEAD”方法。</p>
<p>当采用长连接进行健康检查时，需在该指令中添加keep-alive请求头，如：”HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n”。<br>同时，在采用”GET”方法的情况下，请求uri的size不宜过大，确保可以在1个interval内传输完成，否则会被健康检查模块视为后端服务器或网络异常。</p>
<p><strong>check_http_expect_alive</strong></p>
<p>&emsp;&emsp;该指令指定HTTP回复的成功状态，默认认为2XX和3XX的状态是健康的。如果爬虫多404多可以把4XX也写进去。</p>
<ol>
<li><h2 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h2></li>
</ol>
<blockquote>
<p>rewrite功能就是，使用nginx提供的全局变量或自己设置的变量，结合正则表达式和标志位实现url重写以及重定向。rewrite只能放在server{},location{},if{}中，并且只能对域名后边的除去传递的参数外的字符串起作用</p>
</blockquote>
<p><strong>语法</strong><br><code>rewrite regex replacement [flag];</code></p>
<p>flag标志位</p>
<ul>
<li>last – 相当于Apache的[L]标记，表示完成rewrite，浏览器地址不变</li>
<li>break – 中止 Rewirte，不再继续匹配，浏览器地址不变</li>
<li>redirect – 返回临时重定向的 HTTP 状态 302 浏览器地址显示跳转后的地址</li>
<li>permanent – 返回永久重定向的 HTTP 状态 301 浏览器地址显示跳转后的地址</li>
</ul>
<p>last一般写在server和if中，而break一般使用在location中</p>
<p>last不终止重写后的url匹配，即新的url会再从server走一遍匹配流程，而break终止重写后的匹配。</p>
<p><strong>简单举例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 访问&#x2F;example.html 的时候重写到&#x2F;index.html</span><br><span class="line">rewrite &#x2F;example.html &#x2F;index.html last;</span><br><span class="line">&#x2F;&#x2F; 访问&#x2F;example.html 的时候重写到&#x2F;index.html,并停止匹配</span><br><span class="line">rewrite &#x2F;example.html &#x2F;index.html break;</span><br><span class="line">&#x2F;&#x2F; 把 &#x2F;search&#x2F;key &#x3D;&gt; &#x2F;search.html?keyword&#x3D;key</span><br><span class="line">rewrite &#39;^&#x2F;images&#x2F;([a-z]&#123;2&#125;)&#x2F;([a-z0-9]&#123;5&#125;)&#x2F;(.*)\.(png|jpg|gif)$&#39; &#x2F;data?file&#x3D;$3.$4 last;</span><br><span class="line"> &quot;^&quot; 表示开头匹配 &quot;$&quot; 表示结尾匹配 而且表示路径的&quot;&#x2F;&quot;是需要转义的，&quot;$1&quot;表示表达式匹配到的第一个括号里面的内容，即([a-z]&#123;2&#125;)</span><br></pre></td></tr></table></figure>

<p>正则实例可以<a href="http://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html">参考</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/07/nginx%E4%B9%8BHTTPS%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/07/nginx%E4%B9%8BHTTPS%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">nginx之HTTPS配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-07 15:15:38" itemprop="dateCreated datePublished" datetime="2017-07-07T15:15:38+08:00">2017-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>https现在是标配了，HTTPS 可以给用户带来更安全、比如减少了被劫持的概率，更好隐私保护的网络体验，这些好处大家都耳熟能详，本文不再赘述。现在很多浏览器都在推行HTTPS的普及。尽快升级吧。</p>
</blockquote>
<p>其实大体就是分为<code>ssl证书申请</code>和<code>配置HTTPS</code>两个步骤</p>
<h2 id="证书申请"><a href="#证书申请" class="headerlink" title="证书申请"></a>证书申请</h2><p>这次介绍并没有从申请证书开始，因为之前已经申请过了，申请步骤请<a href="https://aotu.io/notes/2016/08/16/nginx-https/index.html">参考</a><br>SSL 证书主要有两个功能：加密和身份证明，通常需要购买，也有免费的，通过第三方 SSL 证书机构颁发。分为企业级别和个人级别。<br>SSL 具体加密实现<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">参考</a><br>查看证书相关配置，包括哪个机构颁发的，过期时间等等信息可以到<a href="https://www.chinassl.net">https://www.chinassl.net</a> 自助查看</p>
<h2 id="nginx-HTTPS配置"><a href="#nginx-HTTPS配置" class="headerlink" title="nginx HTTPS配置"></a>nginx HTTPS配置</h2><p>首先我们把得到的domain.key domain.crt 放到 nginx的conf下，<br>可以在nginx.conf 的<code>server</code>中配置</p>
<p><strong>基础配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> server &#123;</span><br><span class="line">     listen              443 ssl http2;</span><br><span class="line">     #证书文件(注意路径及权限)</span><br><span class="line">     ssl on;</span><br><span class="line">     ssl_certificate     example.com.crt;</span><br><span class="line">     #私钥文件</span><br><span class="line">     ssl_certificate_key example.com.key;</span><br><span class="line">     ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">     ssl_ciphers         HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">#....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>必须使用监听命令 listen 的 ssl 参数和定义服务器证书文件和私钥文件</p>
<p><code>ssl_protocols</code> 可以用来限制连接只包含 SSL/TLS 的加強版本，默认值如上。<br><code>ssl_ciphers</code> 选择加密套件，不同的浏览器所支持的套件（和顺序）可能会不同。这里指定的是OpenSSL库能够识别的写法，你可以通过 openssl -v cipher ‘RC4:HIGH:!aNULL:!MD5’（后面是你所指定的套件加密算法） 来看所支持算法。</p>
<p><strong>加强 HTTPS 安全性</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl_prefer_server_ciphers ON;</span><br><span class="line">add_header X-Frame-Options DENY;</span><br><span class="line">add_header X-Content-Type-Options nosniff;</span><br><span class="line">add_header X-Xss-Protection 1;</span><br></pre></td></tr></table></figure>

<p><code>ssl_prefer_server_ciphers ON</code>设置协商加密算法时，优先使用我们服务端的加密套件，而不是客户端浏览器的加密套件。<br><code>add_header X-Frame-Options DENY</code>减少点击劫持</p>
<p><strong>HTTPS优化参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line"></span><br><span class="line">ssl_session_timeout 10m;</span><br><span class="line">ssl_buffer_size 1400;</span><br></pre></td></tr></table></figure>

<p><code>ssl_session_cache shared:SSL:10m;</code> 设置ssl/tls会话缓存的类型和大小。如果设置了这个参数一般是shared，buildin可能会参数内存碎片，默认是none，和off差不多，停用缓存。如shared:SSL:10m表示我所有的nginx工作进程共享ssl会话缓存，官网介绍说1M可以存放约4000个sessions。<br><code>ssl_session_timeout 10m;</code>  客户端可以重用会话缓存中ssl参数的过期时间。<br><code>ssl_buffer_size 1400;</code> 缓冲区调优，从1.5.9版本开始,Nginx允许使用ssl_buffer_size指令自定义TLS缓冲区的大小，默认值是 16 KB,但是这个值不一定是最优化的,尤其是你希望首字节数据被尽早发送时,有报告显示使 用1400字节的配置可以显著减少延迟。<a href="http://fangpeishi.com/optimizing-tls-record-size.html">参考</a></p>
<p><strong>配置参考</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ssl                  on;</span><br><span class="line">ssl_session_timeout  30m;</span><br><span class="line">ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line"></span><br><span class="line">ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!CAMELLIA;</span><br><span class="line"></span><br><span class="line">ssl_prefer_server_ciphers   on;</span><br><span class="line">ssl_buffer_size 1400;</span><br><span class="line"></span><br><span class="line">ssl_session_cache    shared:SSL:10m;</span><br><span class="line">ssl_certificate      domain.crt;</span><br><span class="line">ssl_certificate_key  domain.key;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/06/influxdb%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/06/influxdb%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">influxdb使用笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-06 20:00:36" itemprop="dateCreated datePublished" datetime="2017-07-06T20:00:36+08:00">2017-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/influxdb/" itemprop="url" rel="index"><span itemprop="name">influxdb</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>之前从ucloudAPI上取下来的数据需要存到influxdb中，在grafana中进行展示。grafana是我自行部署推广使用的，influxdb是别的同事之前就开始用了。我这次正好用上，所以仔细看了下。虽然人家都把API封装好了，只是拿过来就用的事儿。但是我只是个爱学习的孩子。。。</p>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p>关于时序数据库，除了常用的ElasticSearch之外，InfluxDB也是一个选择。</p>
</blockquote>
<p>InfluxDB 使用 go 语言编写。个人认为几个外在的优点在于：</p>
<ul>
<li>无特殊依赖，几乎开箱即用（如ES需要Java）；</li>
<li>自带HTTP管理界面，免插件配置（如ES的kopf或者head）；</li>
<li>自带数据过期功能；</li>
<li>类SQL查询语句（再提ES，查询使用自己的DSL，虽然也可以通过sql插件来使用类SQL进行查询）；</li>
<li>自带权限管理，精细到“表”级别；</li>
</ul>
<h2 id="关键词解读"><a href="#关键词解读" class="headerlink" title="关键词解读"></a>关键词解读</h2><p>参考<a href="https://docs.influxdata.com/influxdb/v1.0/concepts/glossary">官方文档</a></p>
<ul>
<li><code>time</code>  这个概念首先说明，influxdb本身就是一个时序数据库类似Elasticsearch，所以用来做流处理是很好的，一次插入，多次读写，少改动。 每次插入一条数据都必须要求一个时间戳，自己不定义他就自动生成。</li>
<li><code>database</code>  就是数据库</li>
<li><code>measurement</code> 相当于mysql中的table</li>
<li><code>field</code> 类似于MySQL的字段，没有索引的列，是influxDB数据必须的组成部分。</li>
<li><code>tags</code> 相当于MySQL带索引的字段，不必须</li>
<li><code>retention policy (RP)</code> 描述数据存储多久，以及规定几个分片</li>
<li><code>point</code> 同一时间戳产生的数据集合</li>
<li><code>sereis</code>  measurement, tag set, and retention policy 都相同的数据集合</li>
</ul>
<p>##influx 命令使用</p>
<blockquote>
<p>一般我们直接在bash中执行这个命令可以进到influx的交互界面。然后执行一些cli。<br>但是还有个<code>-execute</code>参数比较常用，执行一条命令然后直接返回结果。<br>比如自己在写关于influxdb的shell脚本的时候。想要得到所有database的列表。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">influx -execute &#39;show databases&#39;</span><br></pre></td></tr></table></figure>

<h2 id="CLI命令"><a href="#CLI命令" class="headerlink" title="CLI命令"></a>CLI命令</h2><blockquote>
<p>CLI<a href="https://docs.influxdata.com/influxdb/v1.2/introduction/getting_started/">官方文档</a><br>influx的CLI命令与mysql还是有很多相似之处的。不过用influxdb我们更多的是用他的API很少用到CLI，只是了解下，自己调试代码的时候可以验证一下自己的数据到底写没写进来。</p>
</blockquote>
<h3 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">显示所有用户:</span><br><span class="line"></span><br><span class="line">SHOW USERS</span><br><span class="line"></span><br><span class="line">显示用户权限:</span><br><span class="line"></span><br><span class="line">show grants for infrasre</span><br><span class="line"></span><br><span class="line">创建用户:</span><br><span class="line"></span><br><span class="line">CREATE USER leo WITH PASSWORD &#39;admin&#39;</span><br><span class="line"></span><br><span class="line">用户赋权:</span><br><span class="line"></span><br><span class="line">grant all on qbus_jmx to infrasre</span><br><span class="line"></span><br><span class="line">删除权限：</span><br><span class="line">revoke read on mydb from dlan</span><br><span class="line"></span><br><span class="line">修改用户(密码):</span><br><span class="line">SET PASSWORD FOR leo &#x3D; &#39;admin&#39;</span><br><span class="line"></span><br><span class="line">删除用户:</span><br><span class="line">DROP USER leo</span><br></pre></td></tr></table></figure>

<p>查看用户权限:<br>SHOW GRANTS FOR doulikeme</p>
<h4 id="建库"><a href="#建库" class="headerlink" title="建库"></a>建库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE mydb</span><br><span class="line"></span><br><span class="line">验证：</span><br><span class="line">SHOW DATABASES</span><br><span class="line"></span><br><span class="line">使用：</span><br><span class="line">USE mydb</span><br></pre></td></tr></table></figure>

<p>现在，建好库可以插入数据了。</p>
<p><strong>数据类型</strong><br>只支持以下几种<br><code>float</code>,<code>integer</code>,<code>string</code>,<code>Boolean</code>,<code>Timestamp</code></p>
<h4 id="建表并插入数据"><a href="#建表并插入数据" class="headerlink" title="建表并插入数据"></a>建表并插入数据</h4><p>这条命令表示: 新建一个表名为<code>cpu</code>的表，设置<code>host</code>为<code>serverA</code>,<code>region</code>为<code>us_west</code>,<code>value</code>为0.64,其中 <strong>host,region</strong> 属性为<code>tags</code>, <strong>value</strong> 属性为<code>field</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT cpu,host&#x3D;serverA,region&#x3D;us_west value&#x3D;0.64</span><br></pre></td></tr></table></figure>

<p><strong>删除表</strong></p>
<pre><code>drop measurement disk_free</code></pre><h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;host&quot;, &quot;region&quot;, &quot;value&quot; FROM &quot;cpu&quot; WHERE &quot;value&quot;&gt;0.9</span><br><span class="line">按照时间范围查看</span><br><span class="line">查看一分钟之前的</span><br><span class="line">SELECT &quot;host&quot;, &quot;region&quot;, &quot;value&quot; FROM &quot;cpu&quot; WHERE time &gt; now() - 1m</span><br><span class="line">查看某天(2017-11-01)</span><br><span class="line">SELECT &quot;host&quot;, &quot;region&quot;, &quot;value&quot; FROM &quot;cpu&quot; WHERE time &gt; &#39;2017-11-01T00:00:00Z&#39; AND time &lt; &#39;2017-11-02T00:00:00Z&#39;</span><br><span class="line">按时间倒序排列(最新10条)</span><br><span class="line">SELECT &quot;host&quot;, &quot;region&quot;, &quot;value&quot; FROM &quot;cpu&quot; ORDER BY time DESC limit 10</span><br><span class="line"></span><br><span class="line">查看tag值</span><br><span class="line">SHOW TAG VALUES on qbus_topic_flow FROM cluster_flow WITH KEY &#x3D; &quot;cluster_name&quot;</span><br></pre></td></tr></table></figure>

<h4 id="删除行"><a href="#删除行" class="headerlink" title="删除行"></a>删除行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DROP SERIES FROM cluster_flow WHERE cluster_name&#x3D;&#39;qbus_topic_flow&#39;</span><br><span class="line"></span><br><span class="line">按照时间节点删除</span><br><span class="line">delete from cluster_flow where time &gt;&#x3D; 1540310461849704691</span><br></pre></td></tr></table></figure>



<h3 id="保留时间"><a href="#保留时间" class="headerlink" title="保留时间"></a>保留时间</h3><p><code>retention policy</code> 用来定义数据在InfluxDB中存放的时间，或者定义保存某个期间的数据。<br>一个数据库可以有多个保留策略，但每个策略必须是独一无二的。<br>默认数据库的保留时间是无限久的。</p>
<p><strong>查询数据库保留策略</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW RETENTION POLICIES ON test_database</span><br></pre></td></tr></table></figure>
<p><strong>新建保留策略</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#新建一条两天的保留策略到test_database 副本为1 指定为DEFAULT 默认</span><br><span class="line">CREATE RETENTION POLICY &quot;2day&quot; ON &quot;test_database&quot; DURATION 2d REPLICATION 1 DEFAULT</span><br></pre></td></tr></table></figure>

<p><strong>更改保留策略</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER RETENTION POLICY &quot;2day&quot; ON &quot;test_database&quot; DURATION 4day DEFAULT</span><br></pre></td></tr></table></figure>

<p><strong>删除保留策略</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop retention POLICY &quot;2day&quot; ON &quot;test_database&quot;</span><br></pre></td></tr></table></figure>
<h3 id="备份-amp-amp-恢复"><a href="#备份-amp-amp-恢复" class="headerlink" title="备份&amp;&amp;恢复"></a>备份&amp;&amp;恢复</h3><p>官网地址：<a href="https://docs.influxdata.com/influxdb/v1.2/administration/backup_and_restore/">https://docs.influxdata.com/influxdb/v1.2/administration/backup_and_restore/</a><br>百度或者Google中文的文档都不太靠谱，还会查看官方文档好一些。</p>
<blockquote>
<p>目前开源用户只有全量备份，企业付费集群用户有增量备份，还有比较不错的机制，但是穷逼就是穷逼，想办法做好自己的全量备份就好了。最主要看到这句话”Each database must be backed up individually.”我的心都凉了，果然付费跟不付费待遇差太多了。so..只能每个数据库单独备份。</p>
</blockquote>
<p><strong>备份</strong></p>
<blockquote>
<p>需要指定数据库，不然只会备份<code>internal</code>,然后指定备份文件存放目录，我们这里使用<code>/data/influx_backup</code>目录</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#单数据库备份</span><br><span class="line">influxd backup -database test_database &#x2F;data&#x2F;influx_backup</span><br></pre></td></tr></table></figure>

<p>其他参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-retention &lt;retention policy name&gt;</span><br><span class="line">-shard &lt;shard ID&gt;</span><br><span class="line">-since &lt;date&gt; 没有 --end 并没有什么卵用</span><br></pre></td></tr></table></figure>

<p><strong>恢复</strong></p>
<blockquote>
<p>需要指定<code>源数据文件夹</code>和<code>备份数据文件夹</code> </p>
</blockquote>
<ol>
<li>恢复meta data</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">influxd restore -metadir &#x2F;var&#x2F;lib&#x2F;influxdb&#x2F;meta &#x2F;data&#x2F;influx_backup</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>恢复数据库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">influxd restore -database telegraf -datadir &#x2F;var&#x2F;lib&#x2F;influxdb&#x2F;data &#x2F;data&#x2F;influx_backup</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>更改目录权限之后重启服务</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R influxdb:influxdb &#x2F;var&#x2F;lib&#x2F;influxdb</span><br><span class="line"></span><br><span class="line">service influxdb restart</span><br></pre></td></tr></table></figure>

<h2 id="HTTP-API使用"><a href="#HTTP-API使用" class="headerlink" title="HTTP API使用"></a>HTTP API使用</h2><p><a href="https://docs.influxdata.com/influxdb/v1.0/guides/writing_data/">官方文档查看</a></p>
<p>建库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XPOST http:&#x2F;&#x2F;localhost:8086&#x2F;query --data-urlencode &quot;q&#x3D;CREATE DATABASE mydb&quot;</span><br></pre></td></tr></table></figure>

<p>单条数据写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XPOST &#39;http:&#x2F;&#x2F;localhost:8086&#x2F;write?db&#x3D;mydb&#39; --data-binary &#39;cpu_load_short,host&#x3D;server01,region&#x3D;us-west value&#x3D;0.64 1434055562000000000&#39;</span><br></pre></td></tr></table></figure>

<p>多条数据写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XPOST &#39;http:&#x2F;&#x2F;localhost:8086&#x2F;write?db&#x3D;mydb&#39; --data-binary &#39;cpu_load_short,host&#x3D;server02 value&#x3D;0.67</span><br><span class="line">cpu_load_short,host&#x3D;server02,region&#x3D;us-west value&#x3D;0.55 1422568543702900257</span><br><span class="line">cpu_load_short,direction&#x3D;in,host&#x3D;server01,region&#x3D;us-west value&#x3D;2.0 1422568543702900257&#39;</span><br></pre></td></tr></table></figure>


<h2 id="Continuous-Queries"><a href="#Continuous-Queries" class="headerlink" title="Continuous Queries"></a>Continuous Queries</h2><blockquote>
<p>influxdb 不仅自带了数据聚合，还有个很好用的数据聚合功能。</p>
</blockquote>
<p>CQ 是以database单位的，每个database可以存在多个CQ。但是它只能被创建一次，想做修改必须删除重新创建。。</p>
<p><strong>应用场景</strong></p>
<ul>
<li>做数据报表</li>
</ul>
<p><strong>查看</strong></p>
<pre><code>SHOW CONTINUOUS QUERIES</code></pre><p><strong>删除</strong></p>
<pre><code>DROP CONTINUOUS QUERY &lt;cq_name&gt; ON &lt;database_name&gt;</code></pre><p><strong>创建</strong></p>
<pre><code>CREATE CONTINUOUS QUERY BytesOut_group ON qbus_jmx BEGIN SELECT sum(value) INTO qbus_jmx.autogen.BytesOOutPerSec_OneDay FROM qbus_jmx.autogen.BytesOutPerSec_OneMinuteRate GROUP BY time(1d), &quot;group&quot; END</code></pre><p><strong>补全之前数据</strong><br>因为</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/06/nginx%E4%B9%8B%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/06/nginx%E4%B9%8B%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">nginx之安装配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-06 19:52:30" itemprop="dateCreated datePublished" datetime="2017-07-06T19:52:30+08:00">2017-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>nginx 相关知识参考网站<br><a href="http://tengine.taobao.org/">Tengine</a></p>
<blockquote>
<p>nginx 首先从安装配置说起问题说起</p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>一般都是源码编译安装，直接解压编译安装就好没有啥可说的 一般需要安装PCRE zlib openssl 库 以及所需要模块例如openLDAP等</p>
</blockquote>
<p><strong>特别说明</strong><br>安装完成之后再添加模块,需要重启服务，reload不会生效。<br><a href="http://taokey.blog.51cto.com/4633273/1318719">参考链接</a></p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><blockquote>
<p>nginx的配置是一门很深的功课，首先我们要对基本的http协议特别了解，配置过程可能要各种rewrite，各种location。不要慌，一点一点来。</p>
</blockquote>
<h2 id="配置文件参数详解"><a href="#配置文件参数详解" class="headerlink" title="配置文件参数详解"></a>配置文件参数详解</h2><blockquote>
<p>首先对<code>nginx.conf</code>里面的各个配置项进行一下解释。 </p>
</blockquote>
<p>首先说下少数几个高级配置，一般写在开头，模块配置之上<br><strong>进程运行的用户组</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user  nginx nginx;</span><br></pre></td></tr></table></figure>

<p><strong>进程数</strong> 一般跟CPU核数相匹配。nginx启动后有多少个worker处理请求，不包括master，(master不处理请求，二十主要接受客户端的请求并分配给worker处理)这里还涉及到下边要说的<code>worker_connections</code>, 正常被大家接受的nginx最大连接数就是靠这两个计算出来的.</p>
<ul>
<li>nginx作为http服务器的时候：<ul>
<li>max_clients = worker_processes * worker_connections</li>
</ul>
</li>
<li>nginx作为反向代理服务器的时候：<ul>
<li>max_clients = worker_processes * worker_connections/4</li>
</ul>
</li>
</ul>
<p>具体为什么去<a href="http://liuqunying.blog.51cto.com/3984207/1420556">参考</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  8;</span><br></pre></td></tr></table></figure>

<p><strong>最大打开文件数量</strong> 这个如果没有设置会使用linux系统默认的文件最大打开数 <code>ulimit -a</code>可以查看到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure>

<h3 id="Events模块"><a href="#Events模块" class="headerlink" title="Events模块"></a>Events模块</h3><p>这里包含nginx所有处理连接的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections 2048;</span><br><span class="line"></span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>worker_connections</code>表示一个worker同时打开最大连接数。<br><code>use epoll</code>定义轮询方法 如果你的内核为linux 2.6+ 应该使用epoll异步非阻塞模型</p>
<h3 id="http模块"><a href="#http模块" class="headerlink" title="http模块"></a>http模块</h3><blockquote>
<p>HTTP模块控制着nginx http处理的所有核心特性</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"> </span><br><span class="line">    server_tokens off;</span><br><span class="line"> </span><br><span class="line">    sendfile on;</span><br><span class="line"></span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server_tokens</code> 这个只是在错误页面不显示nginx版本，为了安全。<br><code>sendfile</code> ,<code>tcp_nopush</code>,<code>tcp_nodelay</code>这三条一般同时出现 提高读写速度 提升性能 ，tcp_nopush 依赖sendfile, tcp_nodelay 不缓存数据，(禁用nagle算法，发送小数据不缓存直接发)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format main &#39;$remote_addr - - [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                &#39;&quot;$http_user_agent&quot; [$request_time, $upstream_response_time] $host ($remote_port) &quot;sid&#x3D;$cookie_sessionid&quot;&#39;;</span><br><span class="line">access_log  logs&#x2F;access.log  main;</span><br></pre></td></tr></table></figure>

<p>定义日志格式 <code>main</code> 下边引用该格式。其实可以设置成json格式的，以后收集解析也方便。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lingering_close off;</span><br><span class="line">keepalive_timeout 5;</span><br><span class="line">send_timeout 20;</span><br><span class="line">proxy_connect_timeout 30;</span><br><span class="line">proxy_read_timeout 20;</span><br><span class="line">proxy_send_timeout 20;</span><br></pre></td></tr></table></figure>

<p><code>lingering_close</code> 定义关闭连接的方式，有三个选项 <strong>off|on|always</strong> <code>off</code>：请求完成之后，关闭连接，不管此时有没有收到客户端数据；<code>on</code>是中间值，一般情况下在关闭连接前都会处理连接上的用户发送的数据，除了有些情况下在业务上认定这之后的数据是不必要的；<code>always</code>无条件处理完所有用户请求。Tengine 默认off效率高些，但是存在误杀状况，nginx默认on 算个小坑。</p>
<p><code>keepalive_timeout</code> 给客户端分配keep-alive链接超时时间</p>
<p><code>send_timeout</code> 发送响应的超时时间，两个客户端请求之间的时间</p>
<p>这几个一般用在nginx做反向代理的时候<br><code>proxy_connect_timeout</code> 后端服务器连接的超时时间_发起握手等候响应超时时间<br><code>proxy_read_timeout</code> 后端服务器处理请求的时间<br><code>proxy_send_timeout</code> 后端服务器数据回传时间_就是在规定时间之内后端服务器必须传完所有的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">include &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">default_type application&#x2F;octet-stream;</span><br></pre></td></tr></table></figure>

<p>include只是一个在当前文件中包含另一个文件内容的指令。这里我们使用它来加载稍后会用到的一系列的MIME类型。其实就是content-type与扩展名的映射。在客户端发来一个请求之后，nginx通过扩展名找到对应的content-type,下载返回的头信息中，浏览器收到之后会按照这个类型做解析展示。这样就不至于发生css文件本当做html一样当文本展示了。如果在mime.types中没有找到，会使用default_type</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## GZIP Setting</span><br><span class="line">gzip  on;</span><br><span class="line">gzip_min_length  1000;</span><br><span class="line">gzip_buffers     4 8k;</span><br><span class="line">gzip_http_version  1.0;</span><br><span class="line">gzip_comp_level  5;</span><br><span class="line">gzip_types       text&#x2F;plain text&#x2F;css application&#x2F;x-javascript application&#x2F;json application&#x2F;xml;</span><br></pre></td></tr></table></figure>

<p>gzip是GNU zip的缩写，它是一个GNU自由软件的文件压缩程序，可以极大的加速网站.有时压缩比率高到80%,近来测试了一下,最少都有40%以上,还是相当不错的。</p>
<p><code>gzip</code><br>决定是否开启gzip模块</p>
<p><code>gzip_min_length</code><br>当返回内容大于此值时才会使用gzip进行压缩,以K为单位,当值为0时，所有页面都进行压缩<br><code>gzip_buffers</code><br>设置gzip申请内存的大小,其作用是按块大小的倍数申请内存空间<br><code>gzip_http_version</code><br>用于识别http协议的版本，早期的浏览器不支持gzip压缩，用户会看到乱码，所以为了支持前期版本加了此选项,目前此项基本可以忽略<br><code>gzip_comp_level</code><br>设置gzip压缩等级，等级越底压缩速度越快文件压缩比越小，反之速度越慢文件压缩比越大<br><code>gzip_types</code><br>设置需要压缩的MIME类型,非设置值不进行压缩</p>
<h2 id="server模块"><a href="#server模块" class="headerlink" title="server模块"></a>server模块</h2><blockquote>
<p>server模块是http的子模块，定义虚拟主机</p>
</blockquote>
<p>格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name map.baidu.com www.baidu.com; </span><br><span class="line">    client_max_body_size 10m;</span><br><span class="line">    root   &#x2F;Users&#x2F;yangyi&#x2F;www;</span><br><span class="line">    index  index.php index.html index.htm; </span><br><span class="line">    charset utf-8;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server {}</code> server标志虚拟主机开始，在 {} 中配置<br><code>listen</code>监听 80端口<br><code>server_name</code>用来指定IP地址或者域名，多个域名之间用空格分开。这里指定域名为map.baidu.com 或者<a href="http://www.baidu.com。">www.baidu.com。</a><br><code>client_max_body_size</code>  文件上传大小<br><code>charset</code> 声明网站默认编码格式</p>
<p>直接转发到到10.0.0.1:9000，这几个proxy_set_header的意思是改变请求头的Host为客户端的Host，ip 否则在下层的服务端会认为客户端是这台代理的nginx。<br>X-Forwarded-For 是一个 HTTP 扩展头部。HTTP/1.1（RFC 2616）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 RFC 7239（Forwarded HTTP Extension）标准之中。<br>格式如下</p>
<blockquote>
<p>X-Forwarded-For: client, proxy1, proxy2</p>
</blockquote>
<p>可以看到，XFF 的内容由「英文逗号 + 空格」隔开的多个部分组成，最开始的是离服务端最远的设备 IP，然后是每一级代理设备的 IP。<br>如果一个 HTTP 请求到达服务器之前，经过了三个代理 Proxy1、Proxy2、Proxy3，IP 分别为 IP1、IP2、IP3，用户真实 IP 为 IP0，那么按照 XFF 标准，服务端最终会收到以下信息：</p>
<blockquote>
<p>X-Forwarded-For: IP0, IP1, IP2</p>
</blockquote>
<p>这个在多级代理的时候可以设置下，逻辑关系更清晰。</p>
<h2 id="location-模块"><a href="#location-模块" class="headerlink" title="location 模块"></a>location 模块</h2><blockquote>
<p>在server内部</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">            root   &#x2F;Users&#x2F;yangyi&#x2F;www;</span><br><span class="line">            index  index.php index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;10.0.0.1:9000;</span><br><span class="line">    proxy_redirect default;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure>


<p><strong>一个配置样例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line"></span><br><span class="line">pid &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile 100000;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">events &#123;</span><br><span class="line"></span><br><span class="line">    worker_connections 2048;</span><br><span class="line">    multi_accept on;</span><br><span class="line">    use epoll;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    server_tokens off;</span><br><span class="line">    sendfile on;</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    log_format main &#39;$remote_addr - - [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                &#39;&quot;$http_user_agent&quot; [$request_time, $upstream_response_time] $host ($remote_port) &quot;sid&#x3D;$cookie_sessionid&quot;&#39;;</span><br><span class="line">    access_log  logs&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log crit;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    keepalive_timeout 10;</span><br><span class="line"></span><br><span class="line">    client_header_timeout 10;</span><br><span class="line"></span><br><span class="line">    client_body_timeout 10;</span><br><span class="line">    reset_timedout_connection on;</span><br><span class="line"></span><br><span class="line">    send_timeout 10;</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone&#x3D;addr:5m;</span><br><span class="line">    limit_conn addr 100;</span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type text&#x2F;html;</span><br><span class="line">    charset UTF-8;</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_disable &quot;msie6&quot;;</span><br><span class="line">    gzip_proxied any;</span><br><span class="line">    gzip_min_length 1000;</span><br><span class="line">    gzip_comp_level 6;</span><br><span class="line">    gzip_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;x-javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript;</span><br><span class="line">    open_file_cache max&#x3D;100000 inactive&#x3D;20s;</span><br><span class="line">    open_file_cache_valid 30s;</span><br><span class="line">    open_file_cache_min_uses 2;</span><br><span class="line">    open_file_cache_errors on;</span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;*;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在nginx配置文件中使用系统环境变量"><a href="#在nginx配置文件中使用系统环境变量" class="headerlink" title="在nginx配置文件中使用系统环境变量"></a>在nginx配置文件中使用系统环境变量</h2><p>方法: 借助lua的<code>os.getenv</code> 函数</p>
<p>1, 声明变量 </p>
<pre><code>env test_path;</code></pre><p>2, 获取变量</p>
<pre><code>在server{} 模块中
# TEST_PATH 为系统环境变量
set_by_lua $test_path &apos;return os.getenv(&quot;TEST_PATH&quot;)&apos;; </code></pre><p>3, 引用变量</p>
<pre><code>access_log $test_path main;</code></pre><p>最后 关于nginx和http https等的设置可以参考<a href="https://imququ.com/">博客</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/07/05/%E8%AE%B0%E4%B8%80%E6%AC%A1PHP%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/07/05/%E8%AE%B0%E4%B8%80%E6%AC%A1PHP%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">记一次PHP服务部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-05 18:58:03" itemprop="dateCreated datePublished" datetime="2017-07-05T18:58:03+08:00">2017-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本来很少接触这门世界上最好的语言，公司里面也没有，但是这次有这个需求，考虑到fastcgi与uwsgi有这么一点点共同点，我就照葫芦画瓢，打算用我们测试的nginx做转发。但是踩到几个坑，听我带着悔恨一点一点的说。。。</p>
</blockquote>
<h2 id="nginx代理转发介绍"><a href="#nginx代理转发介绍" class="headerlink" title="nginx代理转发介绍"></a>nginx代理转发介绍</h2><p>我们的测试跟线上的服务都是用nginx做全职代理转发<br>在nginx.conf 声明如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">include &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;servers&#x2F;*&#x2F;upstream.conf;</span><br><span class="line">include &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;servers&#x2F;*&#x2F;site.conf;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以就可以在server目录下建立各种监听二级域名的目录。</p>
<p>类似这种,<code>uwsgi</code>的转发使用<code>uwsgi_pass</code> ,<code>普通web代理</code>使用<code>proxy_pass</code>,<code>fastcgi</code>使用<code>fastcgi_pass</code><br>下面举例uwsgi转发配置说明一下。<br><code>/usr/local/nginx/conf/servers/dier/site.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl http2;</span><br><span class="line">    server_name dier.chunyu.me;</span><br><span class="line"></span><br><span class="line">    include &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;servers&#x2F;common&#x2F;ssl_config.location;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        uwsgi_pass devops_uwsgi;</span><br><span class="line">        include uwsgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name .chunyu.me;</span><br><span class="line"># 强转https</span><br><span class="line">    rewrite  ^&#x2F;(.*)$  https:&#x2F;&#x2F;devops.chunyu.me&#x2F;$1  permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>/usr/local/nginx/conf/servers/dier/upstream.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream devops_uwsgi &#123;</span><br><span class="line">    server 10.9.77.8:5001;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PHP服务部署"><a href="#PHP服务部署" class="headerlink" title="PHP服务部署"></a>PHP服务部署</h2><blockquote>
<p>源码编译安装，全程Google教程,直接按照参考地址配置即可。</p>
</blockquote>
<p>PHP-FPM<br>PHP-FPM是一个PHP FastCGI管理器，是只用于PHP的,可以在 <a href="http://php-fpm.org/download下载得到。PHP-FPM其实是PHP源代码的一个补丁，旨在将FastCGI进程管理整合进PHP包中。必须将它patch到你的PHP源代码中，在编译安装PHP后才可以使用。FPM（FastCGI">http://php-fpm.org/download下载得到。PHP-FPM其实是PHP源代码的一个补丁，旨在将FastCGI进程管理整合进PHP包中。必须将它patch到你的PHP源代码中，在编译安装PHP后才可以使用。FPM（FastCGI</a> 进程管理器）用于替换 PHP-CGI 的大部分附加功能，对于高负载网站是非常有用的。它的功能包括：</p>
<ol>
<li>支持平滑停止/启动的高级进程管理功能；</li>
<li>可以工作于不同的 uid/gid/chroot 环境下，并监听不同的端口和使用不同的 php.ini 配置文件（可取代 safe_mode 的设置）；</li>
<li>stdout 和 stderr 日志记录;</li>
<li>在发生意外情况的时候能够重新启动并缓存被破坏的 opcode;</li>
<li>文件上传优化支持;</li>
<li>“慢日志” – 记录脚本（不仅记录文件名，还记录 PHP backtrace 信息，可以使用 ptrace或者类似工具读取和分析远程进程的运行数据）运行所导致的异常缓慢;</li>
<li>fastcgi_finish_request() – 特殊功能：用于在请求完成和刷新数据后，继续在后台执行耗时的工作（录入视频转换、统计处理等）；</li>
<li>动态／静态子进程产生 ；</li>
<li>基本 SAPI 运行状态信息（类似Apache的 mod_status）；</li>
<li>基于 php.ini 的配置文件。</li>
</ol>
<p>环境配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++</span><br><span class="line">groupadd web</span><br><span class="line">useradd -M -s &#x2F;sbin&#x2F;nologin -g web php</span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y update</span><br><span class="line">yum -y install libmcrypt libmcrypt-devel mcrypt mhash</span><br><span class="line">yum -y install libxml2-devel libpng-devel libjpeg-devel zlib bzip2 bzip2-devel \</span><br><span class="line">libtool-ltdl-devel pcre-devel openssl-devel freetype-devel libcurl-devel icu \</span><br><span class="line">perl-libintl postgresql libicu-devel</span><br></pre></td></tr></table></figure>

<p>下载解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">wget http:&#x2F;&#x2F;cn2.php.net&#x2F;distributions&#x2F;php-5.6.27.tar.gz</span><br><span class="line">tar -zxvf php-5.6.27.tar.gz</span><br><span class="line">cd php-5.6.27&#x2F;</span><br></pre></td></tr></table></figure>

<p>编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure \</span><br><span class="line">--prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;php5.6.27 \</span><br><span class="line">--with-config-file-path&#x3D;&#x2F;usr&#x2F;local&#x2F;php5.6.27&#x2F;etc&#x2F; \</span><br><span class="line">--enable-inline-optimization \</span><br><span class="line">--enable-shared \</span><br><span class="line">--enable-opcache \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--with-fpm-user&#x3D;php \</span><br><span class="line">--with-fpm-group&#x3D;web \</span><br><span class="line">--with-mysql&#x3D;mysqlnd \</span><br><span class="line">--with-mysqli&#x3D;mysqlnd \</span><br><span class="line">--with-pdo-mysql&#x3D;mysqlnd \</span><br><span class="line">--with-gettext \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--with-iconv \</span><br><span class="line">--with-mcrypt \</span><br><span class="line">--with-mhash \</span><br><span class="line">--with-openssl \</span><br><span class="line">--enable-bcmath \</span><br><span class="line">--enable-soap \</span><br><span class="line">--with-libxml-dir \</span><br><span class="line">--enable-pcntl \</span><br><span class="line">--enable-shmop \</span><br><span class="line">--enable-sysvmsg \</span><br><span class="line">--enable-sysvsem \</span><br><span class="line">--enable-sysvshm \</span><br><span class="line">--enable-sockets \</span><br><span class="line">--enable-intl \</span><br><span class="line">--with-curl \</span><br><span class="line">--with-zlib \</span><br><span class="line">--enable-zip \</span><br><span class="line">--with-bz2 \</span><br><span class="line">--enable-xml \</span><br><span class="line">--with-pcre-dir \</span><br><span class="line">--with-gd \</span><br><span class="line">--enable-static \</span><br><span class="line">--enable-wddx \</span><br><span class="line">--with-xmlrpc \</span><br><span class="line">--with-libdir&#x3D;&#x2F;usr&#x2F;lib64 \</span><br><span class="line">--with-jpeg-dir&#x3D;&#x2F;usr&#x2F;lib64 \</span><br><span class="line">--with-freetype-dir&#x3D;&#x2F;usr&#x2F;lib64 \</span><br><span class="line">--with-png-dir&#x3D;&#x2F;usr&#x2F;lib64</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>简单配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp php.ini-development &#x2F;usr&#x2F;local&#x2F;php5.6.27&#x2F;etc&#x2F;php.ini</span><br><span class="line">cp &#x2F;usr&#x2F;local&#x2F;php5.6.27&#x2F;etc&#x2F;php-fpm.conf.default &#x2F;usr&#x2F;local&#x2F;php5.6.27&#x2F;etc&#x2F;php-fpm.conf</span><br></pre></td></tr></table></figure>

<p>创建开机启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;php-fpmd.service</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;The PHP FastCGI Process Manager</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">PIDFile&#x3D;&#x2F;run&#x2F;php-fpm.pid</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;php5.6.27&#x2F;sbin&#x2F;php-fpm --daemonize -g &#x2F;run&#x2F;php-fpm.pid</span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -USR2 $MAINPID</span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -SIGINT $MAINPID</span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable php-fpmd.service</span><br><span class="line">systemctl start php-fpmd.service</span><br></pre></td></tr></table></figure>


<p><code>注意</code> </p>
<p><strong>php.ini</strong> 中设置<code>open_basedir=/usr/local/nginx/html/webapps</code><br><strong>php-frm.conf</strong> 中<code>security.limit_extensions = .php .html .js .css .jpg .jpeg .gif .png .htm .txt</code> </p>
<h2 id="mysql-安装"><a href="#mysql-安装" class="headerlink" title="mysql 安装"></a>mysql 安装</h2><blockquote>
<p>ansible 自动安装，脚本以后会附上，导入数据手动，没有任何问题</p>
</blockquote>
<h2 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h2><blockquote>
<p>我最开始的想法是，在起PHP这个服务的云主机上起一个nginx 做web服务器。但是我组大神告诉我，不用这么麻烦直接用测试服nginx代理就好。于是我没有反驳，毕竟这个看起来更简单更合理。于是我就开始配置。。。</p>
</blockquote>
<p>最开始配置,如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name dier.chunyu.me;</span><br><span class="line"></span><br><span class="line">    location ~ [^.]+\.php$ &#123;</span><br><span class="line">        root   &#x2F;usr&#x2F;share&#x2F;webapps;</span><br><span class="line">        fastcgi_pass 10.0.0.1:9000;</span><br><span class="line">        index index.html index.php;</span><br><span class="line">        #fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写到一半，我突然发现静态文件怎么办，于是我直接把<code>location ~ [^.]+\.php$`` 改成了</code>location /<code>所有文件都这么走。
结果问题就出现了，如下图。css文件的请求头</code>Content_type<code>为</code>text/html` </p>
<p><img src="http://or2jd66dq.bkt.clouddn.com/css_error.png" alt=""><br>我试着在测试服nginx上各种<code>add_header</code> 都不好使，于是请教之前大神，他一脸不屑的看着我，看了三秒。。。然后他解决，我看到机器上文件的修改，一次次add_header ,过了20多分钟，他扭头给我说，这个fastcgi好像不支持静态文件代理，而且他的代码里面没有加判断。你在这个机器上装个nginx吧。。。<br>恩，于是我有用ansible跑了一遍安装nginx的脚本。<br>配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location ~ [^.]+\.php$ &#123;</span><br><span class="line">    root           &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;webapps;</span><br><span class="line">    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    #fastcgi_param  SCRIPT_FILENAME  &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;webapps$fastcgi_script_name;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">    include        fastcgi.conf;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(css|js|png|jpg|jpeg|gif|ico)$ &#123;</span><br><span class="line">    expires max;</span><br><span class="line">    log_not_found off;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>问题解决。。。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>多学习，多看书，少说话</li>
<li>如果说话学会和人一样说话</li>
<li>多做总结，比如写博客加深一下印象，不太懂也没有关系，写着写着有可能就懂了。</li>
</ul>
<h2 id="一台机器上启动两个PHP服务"><a href="#一台机器上启动两个PHP服务" class="headerlink" title="一台机器上启动两个PHP服务"></a>一台机器上启动两个PHP服务</h2><blockquote>
<p>SEO的哥们找我说克隆一个和之前一模一样的服务，我的原则是PHP这种漏洞比较多的服务最好还是给他们独立出来不要跟线上有联系，前不久让一个白帽子给我们扫了一下，我们才发现之前商务部门归到我们这边的一个提供PHP服务的机器直接被人拿到了root的shell，真可怕。于是，我这次把他们的数据库都从线上拆出来了。放在本地。</p>
</blockquote>
<p><strong>方法</strong></p>
<p>直接再装一个php-fpm （我刚开始用一个PHP-fpm提供和两个PHP服务的动态处理在nginx中把他们的静态文件分开，事实证明不可以，会发生一些奇怪的情况，两个系统的各种配置，包括数据库都会混淆）换个端口启动就好了</p>
<p>参考地址](<a href="https://my.oschina.net/yule526751/blog/795807">https://my.oschina.net/yule526751/blog/795807</a>)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/06/30/Git%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/06/30/Git%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Git使用总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-30 16:28:55" itemprop="dateCreated datePublished" datetime="2017-06-30T16:28:55+08:00">2017-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>很长一段时间使用git都是只有 <code>add</code>,<code>commit</code>,<code>pull</code>,<code>push</code>等这几个简单的命令。想想自己也是使用github的人，怎么能只会这些皮毛。</p>
</blockquote>
<p>首先我们知道git主要是做版本控制工具，所以一些概念逻辑都是为了更好地实现这个功能。</p>
<h2 id="三个目录概念"><a href="#三个目录概念" class="headerlink" title="三个目录概念"></a>三个目录概念</h2><p>首先要对概念清楚 </p>
<ul>
<li>Working Directory：工作目录，这个可以简单的理解为你在文件系统里真实看到的文件</li>
<li>Stage（Index）：暂存“目录”，用git add命令添加的文件就到了这里，即将被commit的文件</li>
<li>Repository：项目“目录”，用git commit提交的文件就到了这里</li>
</ul>
<h2 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h2><p>介绍几种比较6的commit的操作，记住使用git的一贯原则还是少量改动频繁提交，方便做版本控制。</p>
<ul>
<li><p>平常我们都是<code>git add ./</code>然后<code>git commit -m &quot;fix&quot;</code>提交代码</p>
</li>
<li><p>这两条可以结合到一起直接<code>git commit -am &quot;fix&quot;</code>就做到了<br>或者指定文件<code>git commit test.txt -m &quot;fix2.0&quot;</code>.</p>
</li>
<li><p>修改上一次提交 <code>git commit --amend -am &quot;fix2.0, 2.5</code> 这样之前2.0的commit_id直接被覆盖了。</p>
</li>
</ul>
<h2 id="checkout"><a href="#checkout" class="headerlink" title="checkout"></a>checkout</h2><ul>
<li><p>分支相关操作：git checkout 分支名/commit hash切换到相应的分支或commit，加上-b参数则会创建分支并切换过去</p>
<ul>
<li>git checkout -b branch3 1a222c3  注意这里commit_id为新分支起点</li>
</ul>
</li>
<li><p>恢复文件相关操作：git checkout [分支名/commit hash/HEAD快捷方式] – 文件名恢复指定分支的最新commit或指定commit或快捷方式指向的commit的文件到工作目录，若省略中间的参数，则</p>
<ul>
<li><p>暂存区有内容且暂存区内容与工作目录不同，则恢复暂存区的状态到工作目录(之前<code>git add</code>过恢复到当时的状态)</p>
</li>
<li><p>暂存区无内容，则恢复HEAD（最新的commit）的状态到工作目录</p>
</li>
</ul>
</li>
</ul>
<h2 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h2><ul>
<li>使用方式基本就是 <code>git diff [source] [target]</code> 也就是说 <code>target</code>相对于<code>source</code>有哪些变化 ,这里的target,source 可以是commit_id也可以是两个分支,同时<code>git diff master branch2</code>和<code>git diff HEAD branch2</code>显示结果是一样的</li>
<li>只给一个参数 这个参数默认是 <code>source</code> 而<code>target</code> 默认是当前分支最新的commit</li>
<li>不给参数 <code>source</code>为暂存区，<code>target</code>为工作目录</li>
<li>如果想要使暂存目录作为target的话，需要使用–cached参数</li>
</ul>
<h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><ul>
<li>git reset [commit hash/分支名/快捷方式] [文件名]类似“git add的反操作”，直接将所在commit的文件状态恢复到暂存区域。省略commit则默认为HEAD，省略文件名默认为所有文件。只改变暂存目录，不改变工作目录，当前commit不变。</li>
<li>git reset –soft [commit hash/分支名/快捷方式]软恢复，将恢复前所在commit的文件状态恢复到暂存区，当前最新commit为参数中的commit。只改变暂存目录，不改变工作目录，当前commit改变。</li>
<li>git reset –hard [commit hash/分支名/快捷方式]硬恢复，强制将整个项目恢复为参数中的commit时的文件状态，清空暂存目录，工作目录clean。暂存目录和工作目录同时被改变，当前commit改变。</li>
</ul>
<p>关于reset命令的其他补充：当前HEAD已经位于“不是最新”，是不是前面的commit都找不回来了？当然不会，reset过的操作也是可以被reset的。有两种方法：</p>
<ol>
<li>如果记得“最新”的hash（，则直接git reset –hard 1a222c3，则项目直接强制恢复到“最新”所在的状态。</li>
<li>如果不记得的话，运行git reflog，这个命令会输出一个列表，包含HEAD发生的所有变化。</li>
</ol>
<h2 id="cherry-pick"><a href="#cherry-pick" class="headerlink" title="cherry-pick"></a>cherry-pick</h2><blockquote>
<p>cherry-pick其实在工作中还挺常用的，就像copy一样，把一个分之上的某个或者某几个commit复制到另一个分之。一种常见的场景就是，比如我在A分支做了几次commit以后，发现其实我并不应该在A分支上工作，应该在B分支上工作，这时就需要将这些commit从A分支复制到B分支去了，这时候就需要cherry-pick命令了</p>
</blockquote>
<p>模拟下上面场景 在master分之上提交了两个commit  一个commit1 一个commit2，发现不应该在master上面操作，应该新建分之branch1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">首先新建分之 从commit0开始，并切到branch1</span><br><span class="line">git checkout -b branch1 commit0</span><br><span class="line">复制master分之 两个commit到当前分之</span><br><span class="line">git cherry-pick commit1 commit2</span><br><span class="line">在master分支上将这两个commit删除。先切回master分支：</span><br><span class="line">git checkout master，运行git reset --hard commit0</span><br></pre></td></tr></table></figure>

<h2 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h2><h2 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/06/27/javascripts%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/06/27/javascripts%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">javascripts记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-27 17:38:57" itemprop="dateCreated datePublished" datetime="2017-06-27T17:38:57+08:00">2017-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>这只是个愿望，有时间就看下，战线有可能会拖得很长，大家不要吐槽。学JS之前我们需要对HTML，CSS有一定的了解。</p>
</blockquote>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>解释型语言</li>
<li>轻量级脚本语言</li>
<li>可以插入到HTML文件中，由浏览器执行</li>
<li>HTML 中的脚本必须位于 <script> 与 </script> 标签之间。</li>
</ul>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><ul>
<li>赋值 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a &#x3D; 1;</span><br></pre></td></tr></table></figure>

<ul>
<li>if 格式(if (条件) {执行语句} 支持嵌套)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (2&gt;1) &#123;</span><br><span class="line">    x &#x3D; 1;</span><br><span class="line">    y &#x3D; 2;</span><br><span class="line">    if (x&gt;y) &#123;</span><br><span class="line">        result &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (x&lt;y) &#123;</span><br><span class="line">        result &#x3D; 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注释</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* 这是注释 *&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数</li>
</ul>
<p><strong>定义:</strong></p>
<script>
function name() 
{
alert("我的第一个 JavaScript");
}
</script>

<p><strong>调用</strong></p>
<p>使用<code>button</code>调用<br><button type="button" onclick="name()">点击这里</button></p>
<h2 id="外部js调用"><a href="#外部js调用" class="headerlink" title="外部js调用"></a>外部js调用</h2><p>类似CSS的外部调用</p>
<p><strong>格式:</strong></p>
<script src="/demo/myScript.js"></script>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/06/27/HTML-CSS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/06/27/HTML-CSS/" class="post-title-link" itemprop="url">HTML/CSS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-27 16:37:22" itemprop="dateCreated datePublished" datetime="2017-06-27T16:37:22+08:00">2017-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:03" itemprop="dateModified" datetime="2020-05-21T20:56:03+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>熟悉前端是我一直以来的理想，有时间就看下总结下。。。</p>
</blockquote>
<p>#HTML</p>
<h1 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h1><h2 id="CSS简介"><a href="#CSS简介" class="headerlink" title="CSS简介"></a>CSS简介</h2><p>语法：<br>selector {属性1:值;属性2：值}</p>
<p>例：</p>
<p>h1 {color:red;text-align:center;}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;style type&#x3D;&quot;text&#x2F;css&quot;&gt;</span><br><span class="line">h1 &#123;color: red&#125;</span><br><span class="line">p &#123;color: blue&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;header 1&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;A paragraph.&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/media/15139201910054.jpg" alt=""></p>
<p>看上面代码 <code>&lt;head&gt;</code>标签中的CSS 声明<code>h1</code>标签内容颜色为红， <code>p</code>标签内容颜色为蓝，其实就是把各个标签的样式在这个里面做一个总的约束，不用写到各个标签当中了。 提高了效率。</p>
<!DOCTYPE html>
<html>
<head>
    <title>test</title>
    <script type="text/javascript">
        alert('Hello, world!')
    </script>>
</head>
<body>

</body>
</html>>

<h2 id="插入方法"><a href="#插入方法" class="headerlink" title="插入方法"></a>插入方法</h2><h3 id="外部样式表"><a href="#外部样式表" class="headerlink" title="外部样式表"></a>外部样式表</h3><p>很多模板中都是使用这种方法，其实就是把写好的CSS样式表文件放到一个独立的文件中，然后在HTML文件中调用。如果页面文件过于多，这种真的是一种不错的方法。</p>
<p><strong>具体用法</strong></p>
<p>每个页面使用 <link> 标签链接到样式表。 <link> 标签在（文档的）头部：</p>
<head>
<link rel="stylesheet" type="text/css" href="mystyle.css">
</head>
浏览器会从文件 mystyle.css 中读到样式声明，并根据它来格式文档。

<p>但是这个<code>mystyle.css</code>文件中不能有任何HTML标签，并且必须用<code>.css</code>结尾。</p>
<h3 id="内部样式表"><a href="#内部样式表" class="headerlink" title="内部样式表"></a>内部样式表</h3><p>对比外部样式表，内部样式表书写在单个HTML文件中，而且只对这个HTML文件<br>写在<code>head</code>标签中。</p>
<h3 id="内联样式"><a href="#内联样式" class="headerlink" title="内联样式"></a>内联样式</h3><p>写在HTML文件中，写在HTML标签之中。</p>
<p>例：</p>
<h1 style="color:blue;margin-left:20px"> hello world</h1>


<p>以上几种方法，如果遇到冲突的情况，比如外部样式表中有定义，内部也有定义，HTML标签中也有定义，这个时候应该怎么办？</p>
<ol>
<li>浏览器缺省设置</li>
<li>外部样式表</li>
<li>内部样式表（位于 <head> 标签内部）</li>
<li>内联样式（在 HTML 元素内部）</li>
</ol>
<p>会按照以上优先级匹配</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanquqi.github.io/2017/06/25/openvpn%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="fanquqi.github.io/images/avatar.gif">
      <meta itemprop="name" content="fanquqi">
      <meta itemprop="description" content="Raise my flag to the new age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fix u dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="fanquqi.github.io/2017/06/25/openvpn%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">openvpn安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-25 09:58:40" itemprop="dateCreated datePublished" datetime="2017-06-25T09:58:40+08:00">2017-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 20:56:04" itemprop="dateModified" datetime="2020-05-21T20:56:04+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="fanquqi.github.io/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">基础运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>openvpn不多作介绍，直接上部署过程</p>
</blockquote>
<h1 id="服务器环境"><a href="#服务器环境" class="headerlink" title="服务器环境"></a>服务器环境</h1><ul>
<li>机器名：host01</li>
<li>操作系统：CentOS Linux release 7.0.1406 (Core)</li>
<li>内网IP：10.<strong>**</strong></li>
<li>外网IP：12.<strong>**</strong></li>
<li>安装方式：yum</li>
<li>openvpn版本：OpenVPN 2.3.12 x86_64-redhat-linux-gnu</li>
</ul>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><h2 id="安装前操作"><a href="#安装前操作" class="headerlink" title="安装前操作"></a>安装前操作</h2><p><code>关闭selinux 配置防火墙</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c\SELINUX&#x3D;disabled&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">iptables -I INPUT -p udp --dport 1194 -m comment --comment &quot;openvpn&quot; -j ACCEPT</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0&#x2F;24 -j MASQUERADE </span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>

<p><code>开启路由转发功能</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#39;&#x2F;net.ipv4.ip_forward&#x2F;s&#x2F;0&#x2F;1&#x2F;&#39; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">echo &quot;1&quot;&gt;&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<p><code>安装openssl，lzo</code>（用于压缩通讯数据，加快传输速度）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl openssl-delvel</span><br><span class="line">yum install lzo</span><br></pre></td></tr></table></figure>

<h2 id="安装步骤-1"><a href="#安装步骤-1" class="headerlink" title="安装步骤"></a>安装步骤</h2><p><code>安装配置openvpn和easy-rsa</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openvpn easy-rsa</span><br></pre></td></tr></table></figure>

<p><code>修改vars文件</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F;2.0&#x2F;vars | grep -Ev &quot;^$|#&quot;</span><br><span class="line">export EASY_RSA&#x3D;&quot;&#96;pwd&#96;&quot;</span><br><span class="line">export OPENSSL&#x3D;&quot;openssl&quot;</span><br><span class="line">export PKCS11TOOL&#x3D;&quot;pkcs11-tool&quot;</span><br><span class="line">export GREP&#x3D;&quot;grep&quot;</span><br><span class="line">export KEY_CONFIG&#x3D;&#96;$EASY_RSA&#x2F;whichopensslcnf $EASY_RSA&#96;</span><br><span class="line">export KEY_DIR&#x3D;&quot;$EASY_RSA&#x2F;keys&quot;</span><br><span class="line">echo NOTE: If you run .&#x2F;clean-all, I will be doing a rm -rf on $KEY_DIR</span><br><span class="line">export PKCS11_MODULE_PATH&#x3D;&quot;dummy&quot;</span><br><span class="line">export PKCS11_PIN&#x3D;&quot;dummy&quot;</span><br><span class="line">export KEY_SIZE&#x3D;2048</span><br><span class="line">export CA_EXPIRE&#x3D;3650</span><br><span class="line">export KEY_EXPIRE&#x3D;3650</span><br><span class="line">export KEY_COUNTRY&#x3D;&quot;CN&quot;</span><br><span class="line">export KEY_PROVINCE&#x3D;&quot;CA&quot;</span><br><span class="line">export KEY_CITY&#x3D;&quot;Bei Jing&quot;</span><br><span class="line">export KEY_ORG&#x3D;&quot;Fort-Funston&quot;</span><br><span class="line">export KEY_EMAIL&#x3D;&quot;me@myhost.mydomain&quot;</span><br><span class="line">export KEY_OU&#x3D;&quot;MyOrganizationalUnit&quot;</span><br><span class="line">export KEY_NAME&#x3D;&quot;EasyRSA&quot;       </span><br><span class="line"></span><br><span class="line">**copy easy_rsa目录**</span><br><span class="line"></span><br><span class="line">cp -r &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F;2.0&#x2F;* &#x2F;etc&#x2F;openvpn&#x2F;</span><br></pre></td></tr></table></figure>


<p>初始化环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source vars</span><br></pre></td></tr></table></figure>

<p>清除keys目录下所有与证书相关的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;clean-all</span><br></pre></td></tr></table></figure>

<p>生成根证书ca.crt 根秘钥ca.key（一路回车）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;build-ca</span><br></pre></td></tr></table></figure>

<p>为服务端生成证书秘钥（一路回车）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;build-key-server server</span><br></pre></td></tr></table></figure>

<p>创建迪菲·赫尔曼密钥，会生成dh2048.pem文件（过程比较慢）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;build-dh</span><br></pre></td></tr></table></figure>

<p>生成ta.key（防DOS攻击，等）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret keys&#x2F;ta.key</span><br></pre></td></tr></table></figure>

<p>创建服务端配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在openvpn目录下创建一个keys目录</span><br><span class="line">mkdir &#x2F;etc&#x2F;openvpn&#x2F;keys</span><br></pre></td></tr></table></figure>

<p>复制一份刚创建好的证书秘钥到新创建的keys</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F;2.0&#x2F;keys&#x2F;&#123;ca.crt,server.&#123;crt,key&#125;,dh2048.pem,ta.key&#125; &#x2F;etc&#x2F;openvpn&#x2F;keys&#x2F;</span><br></pre></td></tr></table></figure>

<p>复制一份配置文件模板到/etc/openvpn/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn-2.3.12&#x2F;sample&#x2F;sample-config-files&#x2F;server.conf &#x2F;etc&#x2F;openvpn&#x2F;</span><br></pre></td></tr></table></figure>

<p>修改一下配置文件(这里使用的udp,会比tcp更快一下)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@vpn ~]# cat &#x2F;etc&#x2F;openvpn&#x2F;server.conf | grep -Ev &quot;^#|;|^$&quot;</span><br><span class="line">port 1194</span><br><span class="line">proto udp</span><br><span class="line">dev tun</span><br><span class="line">ca keys&#x2F;ca.crt</span><br><span class="line">cert keys&#x2F;server.crt</span><br><span class="line">key keys&#x2F;server.key  # This file should be kept secret</span><br><span class="line">dh keys&#x2F;dh2048.pem</span><br><span class="line">server 10.8.3.0 255.255.255.0</span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line">push &quot;route 10.0.0.0 255.0.0.0&quot;</span><br><span class="line">keepalive 10 120</span><br><span class="line">tls-auth keys&#x2F;ta.key 0 # This file is secret</span><br><span class="line">comp-lzo</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">log         openvpn.log</span><br><span class="line">verb 5</span><br></pre></td></tr></table></figure>

<h2 id="openvpn启动"><a href="#openvpn启动" class="headerlink" title="openvpn启动"></a>openvpn启动</h2><p>systemctl -f enable <a href="mailto:openvpn@server.service">openvpn@server.service</a><br>systemctl start <a href="mailto:openvpn@server.service">openvpn@server.service</a></p>
<h2 id="添加-删除用户"><a href="#添加-删除用户" class="headerlink" title="添加|删除用户"></a>添加|删除用户</h2><p><strong>添加用户脚本</strong>(可以使用它自动添加用户)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">vpnServer1&#x3D;10.9.104.39</span><br><span class="line">#vpnServer2&#x3D;10.12.1.28</span><br><span class="line"># a. 在vpnserver01中创建新vpn用户</span><br><span class="line">if [ -z $1 ]</span><br><span class="line">then</span><br><span class="line">  echo &quot;Error:请在脚本后添加用户名作为参数，例如：&#39;.&#x2F;01_addUser.sh zhangsan&#39;&quot;</span><br><span class="line">else</span><br><span class="line">  cp &#x2F;etc&#x2F;openvpn&#x2F;keys&#x2F;$1.crt .&#x2F; &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1</span><br><span class="line">  if [ -f $1.crt ]</span><br><span class="line">  then</span><br><span class="line">    echo &quot;$1 用户已存在，请检查！&quot;</span><br><span class="line">    rm -f *.crt</span><br><span class="line">  else</span><br><span class="line"></span><br><span class="line">    cd &#x2F;etc&#x2F;openvpn&#x2F; &amp;&amp; pwd &amp;&amp; source &#x2F;etc&#x2F;openvpn&#x2F;vars &amp;&amp; .&#x2F;build-key --batch $1</span><br><span class="line">#    cd &#x2F;etc&#x2F;openvpn&#x2F; &amp;&amp; pwd &amp;&amp; source &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F;2.0&#x2F;vars &amp;&amp; .&#x2F;build-key --batch $1</span><br><span class="line">    # b. 新用户配置文件修改以及打包发送mail到用户</span><br><span class="line">    cd -</span><br><span class="line">    mkdir -p $1</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; .&#x2F;$1&#x2F;$1.ovpn</span><br><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line">remote ****** 1194</span><br><span class="line">remote-random</span><br><span class="line">resolv-retry 10</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert $1.crt</span><br><span class="line">key $1.key</span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cp &#x2F;etc&#x2F;openvpn&#x2F;keys&#x2F;&#123;ca.crt,$1.&#123;crt,key&#125;,ta.key&#125; .&#x2F;$1&#x2F;</span><br><span class="line"></span><br><span class="line">#    cp &#x2F;etc&#x2F;openvpn&#x2F;keys&#x2F;$1.&#123;crt,key&#125; &#x2F;home&#x2F;chunyu_sys&#x2F;workspace&#x2F;cy_ansible&#x2F;roles&#x2F;vpn_agent&#x2F;files&#x2F;</span><br><span class="line">    cp README.txt .&#x2F;$1&#x2F;;cp openVPN-clinet-config-for-Mac.pdf .&#x2F;$1&#x2F;</span><br><span class="line">    cp &#x2F;etc&#x2F;hosts .&#x2F;$1&#x2F;chunyu_hosts</span><br><span class="line">    tar czf $1.tar.gz $1&#x2F;</span><br><span class="line">    rm -fr $1&#x2F;</span><br><span class="line">#    python .&#x2F;send_mail.py $1@chunyu.me &quot;[运维][vpn申请]openVPN configuration files&quot; $1.tar.gz</span><br><span class="line">#    mutt -s &quot;openVPN configuration files&quot; -a $1.tar.gz -- xiepengcheng@chunyu.me &lt; $1.tar.gz</span><br><span class="line">    #rm -f $1.tar.gz</span><br><span class="line">    echo &quot;用户 $1 创建完毕&quot;</span><br><span class="line">  fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p><strong>删除用户脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">vpnServer1&#x3D;host01</span><br><span class="line"></span><br><span class="line">if [ -z $1 ]</span><br><span class="line">then</span><br><span class="line">  echo &quot;Error:请在脚本后添加用户名作为参数，例如：&#39;.&#x2F;02_delUser.sh zhangsan&#39;&quot;</span><br><span class="line">else</span><br><span class="line">  cp &#x2F;etc&#x2F;openvpn&#x2F;keys&#x2F;$1.crt .&#x2F;</span><br><span class="line">  if [ -f $1.crt ]</span><br><span class="line">  then</span><br><span class="line">  cd &#x2F;etc&#x2F;openvpn &amp;&amp; source vars &amp;&amp; .&#x2F;revoke-full $1</span><br><span class="line">  rm -rf &#x2F;etc&#x2F;openvpn&#x2F;keys&#x2F;$1.*</span><br><span class="line">  echo &quot;用户 $1 删除完毕&quot;</span><br><span class="line">  cd -</span><br><span class="line">  rm -f $1.crt</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$1 此VPN用户不存在，请检查!&quot;</span><br><span class="line">  fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>


<h2 id="使用TC进行限速"><a href="#使用TC进行限速" class="headerlink" title="使用TC进行限速"></a>使用TC进行限速</h2><p>因为大家都不遵守规则，总是把vpn带宽占满，影响别的用户使用，所以必须加以限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev tun0 root handle 1:0 htb default 10</span><br><span class="line"></span><br><span class="line">tc class add dev tun0 parent 1:0 classid 1:1 htb rate 10Mbit burst 15k</span><br><span class="line"></span><br><span class="line">tc class add dev tun0 parent 1:1 classid 1:10 htb rate 640kbit ceil 640kbit burst 15k</span><br><span class="line"></span><br><span class="line">tc qdisc add dev tun0 parent 1:10 handle 10: sfq perturb 10</span><br><span class="line"></span><br><span class="line">tc filter add dev tun0 protocol ip parent 1:0 prio 3 u32 match ip dst 10.0.0.6 flowid 1:10</span><br></pre></td></tr></table></figure>

<p>上面规则可以控制10.0.0.6这个用户的下载带宽为:80KB/s,以此类推限制其它用户.如果会写shell,可以作一个程序,加到openvpn的拨入脚本中.</p>
<p>上传是在eth0(假如外网卡是eth0)上做.</p>
<p>总结：<br>如果iptables关了，openvpn服务起了，客户端还是连不上，telnet 1194端口也不通，记得把云主机外网防火墙改一下。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="fanquqi.github.io/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="fanquqi.github.io/">1</a><span class="space">&hellip;</span><a class="page-number" href="fanquqi.github.io/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="fanquqi.github.io/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="fanquqi.github.io/page/8/">8</a><a class="extend next" rel="next" href="fanquqi.github.io/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">fanquqi</p>
  <div class="site-description" itemprop="description">Raise my flag to the new age.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="fanquqi.github.io/archives/">
        
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fanquqi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="fanquqi.github.io/lib/anime.min.js"></script>
  <script src="fanquqi.github.io/lib/velocity/velocity.min.js"></script>
  <script src="fanquqi.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="fanquqi.github.io/js/utils.js"></script>

<script src="fanquqi.github.io/js/motion.js"></script>


<script src="fanquqi.github.io/js/schemes/muse.js"></script>


<script src="fanquqi.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
